<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Liga Femenina ‚Äì No puedo, tengo p√°del</title>
  <meta name="theme-color" content="#ffffff">
  <style>
    :root{
      --bg:#f7f9fb; --panel:#ffffff; --text:#0f1220; --muted:#5d667b; --border:#e6e9ef;
      --accent:#2dd24c; --accent-ink:#0a1b10; --danger:#ff5470; --chip:#f0f3f8;
    }
    *{ box-sizing:border-box } body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto; background:var(--bg); color:var(--text) }
    h1,h2{ margin:.2rem 0 } .container{ max-width:1100px; margin:0 auto; padding:20px }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:0 4px 20px rgba(16,24,40,.04) }
    .hd{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border) }
    .bd{ padding:14px 16px }
    .pill{ display:inline-flex; gap:.5rem; align-items:center; padding:.35rem .7rem; border-radius:999px; background:var(--chip); color:#3b4252; font-size:.85rem; border:1px solid var(--border) }
    input,select,button{ padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#fff; color:#111; outline:none }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .primary{ background:var(--accent); color:var(--accent-ink); border:none; font-weight:700 }
    .ghost{ background:#fff } .danger{ background:#ff5470; color:#fff; border:none } .ok{ background:var(--accent); color:#0c1b10; border:none }

    /* Bracket simple */
    .br-list{ display:grid; gap:12px }
    .br-item{ position:relative; border:1px solid var(--border); border-radius:14px; background:#fff; padding:12px 12px 10px }
    .br-top{ display:flex; gap:10px; align-items:center; justify-content:space-between; color:var(--muted); margin-bottom:8px; flex-wrap:wrap }
    .br-grid{ display:grid; grid-template-columns: 1fr 120px 1fr; gap:12px; align-items:center; position:relative }
    /* pilar central para sensaci√≥n de cruce */
    .br-grid::before{
      content:''; position:absolute; top:8px; bottom:8px; left:calc(50% - 1px);
      width:2px; background:linear-gradient(180deg, transparent 0, var(--border) 12px, var(--border) calc(100% - 12px), transparent 100%);
      pointer-events:none;
    }
    .side{ display:flex; align-items:center; gap:8px; min-width:0 }
    .label{ background:var(--chip); border:1px solid var(--border); border-radius:999px; padding:4px 8px; font-weight:700; font-size:.85rem }
    .name{ font-weight:700; max-width:100%; white-space:normal; overflow:visible; text-overflow:clip; line-height:1.2 }
    .score{
      display:grid; grid-template-columns: repeat(6, 48px); gap:8px; justify-content:center; align-items:center; position:relative;
      border-left:1px dashed var(--border); border-right:1px dashed var(--border); padding:6px 10px;
      border-radius:8px;
    }
    .score input{ width:48px; height:44px; text-align:center; font-weight:800; font-size:20px; border-radius:10px }
    .cmds{ display:flex; gap:6px; justify-content:flex-end; flex-wrap:wrap }
    .small{font-size:.9rem;color:var(--muted)}

    @media (max-width:700px){
      .br-grid{ grid-template-columns: 1fr; }
      .score{ justify-content:flex-start; grid-template-columns: repeat(6, 46px) }
      .br-grid::before{ display:none; }
      .name{ max-width:100% }
    }
    @media (max-width:560px){
      .score{ grid-template-columns: repeat(6, 42px) }
      .score input{ width:42px; height:40px; font-size:18px }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="hd" style="border-radius:16px; margin-bottom:12px">
      <div>
        <h1>üèÜ Liga Femenina ‚Äì <span style="color:#10b981">No puedo, tengo p√°del</span></h1>
        <div class="small">Cruces por Ida/Vuelta (sin jornadas) ‚Ä¢ Solo suma puntos el ganador.</div>
      </div>
      <span class="pill" id="connBadge">üåê Supabase</span>
    </header>

    <!-- Parejas -->
    <section class="card" style="margin-bottom:12px">
      <div class="hd"><strong>üë• Parejas</strong>
        <div class="actions">
          <input id="teamName" placeholder="Ej: Jessi/Ck" style="max-width:260px" />
          <button id="addPair" class="primary">Agregar pareja</button>
        </div>
      </div>
      <div class="bd" id="teamList" style="display:flex; flex-direction:column; gap:8px"></div>
    </section>

    <!-- Cruces (todo junto por leg) -->
    <section class="card">
      <div class="hd"><strong>üéæ Cruces</strong>
        <div class="actions">
          <label class="small">Leg:
            <select id="filterLeg" style="width:auto">
              <option value="ida">Ida</option>
              <option value="vuelta">Vuelta</option>
            </select>
          </label>
          <label class="small">Pareja:
            <select id="filterTeam" style="width:auto; min-width:180px"><option value="ALL">Todas</option></select>
          </label>
          <button id="regenFixture" class="ghost">üîÑ Regenerar fixture</button>
        </div>
      </div>
      <div class="bd">
        <div class="small" id="fixtureInfo" style="margin-bottom:8px"></div>
        <div id="bracket" class="br-list"></div>
      </div>
    </section>

    <!-- Tabla -->
    <section class="card" style="margin-top:12px">
      <div class="hd"><strong>üìä Tabla de posiciones</strong></div>
      <div class="bd" style="overflow:auto">
        <table id="standings" style="width:100%;border-collapse:collapse">
          <thead><tr><th>#</th><th>Pareja</th><th>PJ</th><th>PG</th><th>PP</th><th>Games +</th><th>Games ‚àí</th><th>Dif</th><th>Puntos</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <script type="module">
  // ======= Supabase / Config (sin login, sin cach√© local) =======
  const SUPABASE_URL = 'https://dyaptlmncbbmruyduerv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5YXB0bG1uY2JibXJ1eWR1ZXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1Nzc0MjgsImV4cCI6MjA3NjE1MzQyOH0.5bSZuq8G1XW3LYoM92J5skRuUpnUQYbd_oKT3toTSlA';
  const LEAGUE_ID = 'lfnpd-2025';
  const ALLOW_PUBLIC_WRITE = true;

  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));

  // ======= Estado en memoria =======
  let state = { teams: [], matches: [], fixtures:{ida:[],vuelta:[]} };
  const DEFAULT_TEAMS = ['Jessi/Ck','Vanessa/Auri','Patty/Vero','Valen/Sele','Enyor/Stef','Nathaly/Cristina','Nativid/Olga'];

  // ======= Utilidades =======
  const escapeHtml = s => String(s).replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
  const teamName = id => (state.teams.find(t=>t.id===id)||{}).name || '¬ø?';
  const toDateInputValue = v => { if(!v) return ''; const d=new Date(v); if(!isNaN(d)) return d.toISOString().slice(0,10); if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v; return ''; };
  const indexOfTeam = id => state.teams.findIndex(t=>t.id===id);
  const orderPair = (a,b)=> (indexOfTeam(a)<=indexOfTeam(b))? [a,b] : [b,a];
  const comparePairs = (p1a,p1b,p2a,p2b)=>{ const [r1a,r1b]=orderPair(p1a,p1b).map(indexOfTeam); const [r2a,r2b]=orderPair(p2a,p2b).map(indexOfTeam); return (r1a-r2a)||(r1b-r2b); };
  const uid = ()=> Math.random().toString(36).slice(2,9);

  function buildRoundRobin(ids){
    const arr = ids.slice(); if(arr.length%2===1) arr.push('BYE'); const n=arr.length, rounds=[];
    for(let r=0;r<n-1;r++){ const round=[]; for(let i=0;i<n/2;i++){ const a=arr[i], b=arr[n-1-i]; if(a!=='BYE'&&b!=='BYE') round.push([a,b]); } rounds.push(round); arr.splice(1,0,arr.pop()); }
    return rounds;
  }

  // ======= Carga inicial (SIEMPRE desde Supabase) =======
  await reloadAll();
  bindUI();

  async function reloadAll(){
    // Teams
    let { data: teams } = await supabase.from('teams').select('*').eq('league_id', LEAGUE_ID).order('position');
    if(!teams || teams.length===0){
      if(ALLOW_PUBLIC_WRITE){
        const seed = DEFAULT_TEAMS.map((name, i)=>({ name, position:i, league_id:LEAGUE_ID }));
        await supabase.from('teams').insert(seed);
        let t2 = await supabase.from('teams').select('*').eq('league_id', LEAGUE_ID).order('position');
        teams = t2.data||[];
      } else {
        teams = [];
      }
    }
    state.teams = teams.map(t=>({ id:t.id, name:t.name, position:t.position }));

    // Matches
    const { data: matches } = await supabase.from('matches').select('*').eq('league_id', LEAGUE_ID);
    state.matches = (matches||[]).map(m=>({
      id:m.id, uniq:m.uniq, A:m.team_a, B:m.team_b, leg:m.leg, round:m.round,
      sets:m.sets||[], ptsA:Number(m.pts_a||0), ptsB:Number(m.pts_b||0), date:m.date||''
    }));

    // Fixtures (solo memoria)
    const ids = state.teams.map(t=>t.id);
    state.fixtures.ida = buildRoundRobin(ids);
    state.fixtures.vuelta = state.fixtures.ida.map(r=> r.map(p=>[p[1],p[0]]));

    populateTeamFilter();
    renderTeams(); renderBracket(); renderStandings();
  }

  function bindUI(){
    $('#addPair').addEventListener('click', onAddTeam);
    $('#regenFixture').addEventListener('click', ()=>{
      const ids = state.teams.map(t=>t.id);
      state.fixtures.ida = buildRoundRobin(ids);
      state.fixtures.vuelta = state.fixtures.ida.map(r=> r.map(p=>[p[1],p[0]]));
      renderBracket();
    });
    $('#filterLeg').addEventListener('change', renderBracket);
    $('#filterTeam').addEventListener('change', renderBracket);
  }

  async function onAddTeam(){
    const name = $('#teamName').value.trim(); if(!name){ alert('Nombre vac√≠o'); return; }
    if(state.teams.some(t=>t.name.toLowerCase()===name.toLowerCase())){ alert('Ya existe'); return; }
    const position = state.teams.length;
    const { data, error } = await supabase.from('teams').insert({ name, position, league_id: LEAGUE_ID }).select('*').single();
    if(error){ alert('No se pudo guardar en Supabase'); console.warn(error); return; }
    state.teams.push({ id:data.id, name:data.name, position:data.position });
    $('#teamName').value='';
    await reloadAll();
  }

  function renderTeams(){
    const list = $('#teamList');
    list.innerHTML = state.teams.map((t,i)=>`
      <div class="row" style="align-items:center; display:flex; justify-content:space-between; gap:8px; padding:6px 0">
        <div class="col-10" style="flex:1 1 auto"><strong>${escapeHtml(t.name)}</strong> <span class="small">¬∑ #${i+1}</span></div>
        <div class="col-2 actions" style="flex:0 0 auto">
          <button class="ghost" onclick="moveTeam(${i},-1)">‚Üë</button>
          <button class="ghost" onclick="moveTeam(${i},1)">‚Üì</button>
          <button class="danger" onclick="removeTeam('${t.id}')">Eliminar</button>
        </div>
      </div>`).join('') || '<span class="small">Sin parejas</span>';
  }

  window.moveTeam = async (i,dir)=>{
    const j=i+dir; if(j<0 || j>=state.teams.length) return;
    const x=state.teams.splice(i,1)[0]; state.teams.splice(j,0,x);
    state.teams.forEach((t,idx)=> t.position = idx);
    await supabase.from('teams').upsert(state.teams.map(t=>({ id:t.id, position:t.position, league_id: LEAGUE_ID })));
    await reloadAll();
  };
  window.removeTeam = async (id)=>{
    if(!confirm('¬øEliminar esta pareja?')) return;
    await supabase.from('matches').delete().eq('league_id', LEAGUE_ID).or(`team_a.eq.${id},team_b.eq.${id}`);
    await supabase.from('teams').delete().eq('id', id);
    await reloadAll();
  };

  function populateTeamFilter(){
    const opts = ['<option value="ALL">Todas</option>']
      .concat(state.teams.map(t=>`<option value="${t.id}">${escapeHtml(t.name)}</option>`))
      .join('');
    $('#filterTeam').innerHTML = opts;
  }

  // ========== BRACKET (sin jornadas) ==========
  function flatGamesForLeg(leg){
    const rounds = leg==='ida' ? state.fixtures.ida : state.fixtures.vuelta;
    const games = [];
    rounds.forEach((arr,ri)=>{
      arr.forEach((pair,idx)=> games.push({ a:pair[0], b:pair[1], ri, idx }));
    });
    return games;
  }

  function makeSetBox(id, val=''){
    return `<input class="set" id="${id}" type="number" min="0" inputmode="numeric" pattern="[0-9]*" value="${val}">`;
  }

  function makeMatchCard(a,b,leg,ri,idx){
    const [Aid,Bid] = orderPair(a,b);
    const A = escapeHtml(teamName(Aid));
    const B = escapeHtml(teamName(Bid));
    const uniq = [Aid,Bid].join('__')+'_'+leg+'_'+ri+'_'+idx;
    const rec = state.matches.find(m=>m.uniq===uniq) || {};
    const sets = rec.sets||[];
    const dateVal = toDateInputValue(rec.date);

    const inputs = [
      `${uniq}_s1a`,`${uniq}_s1b`,
      `${uniq}_s2a`,`${uniq}_s2b`,
      `${uniq}_s3a`,`${uniq}_s3b`,
    ];

    return `<div class="br-item" data-uniq="${uniq}">
      <div class="br-top">
        <div class="small"><span class="pill">${leg.toUpperCase()}</span></div>
        <div class="small" style="display:flex; align-items:center; gap:8px">
          üìÖ <input id="${uniq}_date" type="date" value="${dateVal||''}" style="width:auto; min-width:140px">
          <div class="cmds">
            <button class="ok" onclick="saveMatch('${Aid}','${Bid}','${leg}',${ri},${idx})">${rec.id?'Actualizar':'Guardar'}</button>
            <button class="ghost" onclick="clearMatch('${uniq}')">Borrar resultado</button>
          </div>
        </div>
      </div>
      <div class="br-grid">
        <div class="side"><span class="label">A</span><div class="name" title="${A}">${A}</div></div>
        <div class="score">
          ${makeSetBox(inputs[0], (sets[0]&&sets[0][0])||'')}
          ${makeSetBox(inputs[1], (sets[0]&&sets[0][1])||'')}
          ${makeSetBox(inputs[2], (sets[1]&&sets[1][0])||'')}
          ${makeSetBox(inputs[3], (sets[1]&&sets[1][1])||'')}
          ${makeSetBox(inputs[4], (sets[2]&&sets[2][0])||'')}
          ${makeSetBox(inputs[5], (sets[2]&&sets[2][1])||'')}
        </div>
        <div class="side" style="justify-content:flex-end"><div class="name" title="${B}">${B}</div><span class="label">B</span></div>
      </div>
    </div>`;
  }

  function renderBracket(){
    const leg = $('#filterLeg').value;
    const teamFilter = $('#filterTeam').value || 'ALL';
    const games = flatGamesForLeg(leg).filter(g=>{
      if(teamFilter==='ALL') return true;
      return g.a===teamFilter || g.b===teamFilter;
    }).sort((g1,g2)=> comparePairs(g1.a,g1.b,g2.a,g2.b));

    const perLeg = state.teams.length*(state.teams.length-1)/2;
    $('#fixtureInfo').textContent = `${leg==='ida'?'Ida':'Vuelta'}: ${games.length} / ${perLeg}`;

    $('#bracket').innerHTML = games.map(g=> makeMatchCard(g.a,g.b,leg,g.ri,g.idx)).join('') || '<div class="small">Sin cruces</div>';

    // Auto-avance por set: A1 -> B1 -> A2 -> B2 -> A3 -> B3 en CADA PARTIDO
    $$('#bracket .br-item').forEach(card=>{
      const uniq = card.dataset.uniq;
      const order = [
        `${uniq}_s1a`, `${uniq}_s1b`,
        `${uniq}_s2a`, `${uniq}_s2b`,
        `${uniq}_s3a`, `${uniq}_s3b`,
      ].map(id=> card.querySelector('#'+CSS.escape(id))).filter(Boolean);

      order.forEach((el,idx)=>{
        el.addEventListener('input', ()=>{
          if(String(el.value).length>=1){
            const next = order[idx+1];
            if(next) next.focus();
          }
        });
        el.addEventListener('keydown', (e)=>{
          if(e.key==='Enter'){ e.preventDefault(); const next = order[idx+1]; if(next) next.focus(); }
          if(e.key==='ArrowDown'){ e.preventDefault(); const next = order[idx+1]; if(next) next.focus(); }
          if(e.key==='ArrowUp'){ e.preventDefault(); const prev = order[idx-1]; if(prev) prev.focus(); }
          if(e.key==='Backspace' && el.value==='' ){ const prev = order[idx-1]; if(prev){ e.preventDefault(); prev.focus(); } }
        });
      });
    });

    // fechas -> guardar en DB si existe el partido
    $$('#bracket input[type="date"]').forEach(inp=>{
      inp.addEventListener('change', async function(){
        const uniq = this.id.replace('_date','');
        const rec = state.matches.find(x=>x.uniq===uniq);
        if(rec){
          rec.date = this.value || null;
          await upsertMatch(rec);
          renderStandings();
        }
      });
    });
  }

  // ========== Guardado / Borrado ==========
  window.saveMatch = async (a,b,leg,ri,idx)=>{
    const [Aid,Bid] = orderPair(a,b);
    const pair = `${Aid}__${Bid}`;
    const uniq = `${pair}_${leg}_${ri}_${idx}`;
    const get = id => document.getElementById(id);

    const vals = [
      [Number(get(uniq+'_s1a')?.value)||0, Number(get(uniq+'_s1b')?.value)||0],
      [Number(get(uniq+'_s2a')?.value)||0, Number(get(uniq+'_s2b')?.value)||0],
      [Number(get(uniq+'_s3a')?.value)||0, Number(get(uniq+'_s3b')?.value)||0],
    ].filter(ab=>ab[0]>0 || ab[1]>0);
    if(vals.length<2){ alert('Carga al menos dos sets'); return; }

    const sw = vals.reduce((acc,[x,y])=> (x>y? (acc.a++,acc): y>x? (acc.b++,acc): acc), {a:0,b:0});
    if(sw.a===sw.b && vals.length<3){ alert('Empate a sets, falta el 3er set'); return; }

    // Puntos: ganador 3, perdedor 0
    const winnerA = sw.a>sw.b;
    let ptsA = winnerA ? 3 : 0;
    let ptsB = winnerA ? 0 : 3;

    const date = (get(uniq+'_date') && get(uniq+'_date').value) || null;

    let rec = state.matches.find(m=>m.uniq===uniq);
    const base = { uniq, A:Aid, B:Bid, leg, round:ri+1, sets: vals, ptsA, ptsB, date };

    if(rec){ Object.assign(rec, base); }
    else { rec = { id: uid(), ...base }; state.matches.push(rec); }

    await upsertMatch(rec);
    renderStandings();
  };

  window.clearMatch = async (uniq)=>{
    const rec = state.matches.find(m=>m.uniq===uniq);
    if(!rec){ clearInputs(uniq); return; }
    if(!confirm('¬øBorrar resultado de este partido?')) return;
    await supabase.from('matches').delete().eq('uniq', rec.uniq).eq('league_id', LEAGUE_ID);
    state.matches = state.matches.filter(m=>m.uniq!==rec.uniq);
    clearInputs(uniq);
    renderStandings();
  };

  function clearInputs(uniq){
    ['_s1a','_s1b','_s2a','_s2b','_s3a','_s3b'].forEach(suf=>{
      const el = document.getElementById(uniq+suf); if(el) el.value='';
    });
  }

  async function upsertMatch(rec){
    const payload = {
      league_id: LEAGUE_ID, uniq: rec.uniq, leg: rec.leg, round: rec.round,
      team_a: rec.A, team_b: rec.B, date: rec.date, sets: rec.sets, pts_a: rec.ptsA, pts_b: rec.ptsB
    };
    const { data, error } = await supabase.from('matches').upsert(payload).select('*').single();
    if(error){ console.warn(error); alert('No se pudo guardar en Supabase'); return; }
    rec.id = data.id;
  }

  // ========== Tabla ==========
  function renderStandings(){
    const stats = {}; state.teams.forEach(t=> stats[t.id]={ id:t.id, name:t.name, PJ:0, PG:0, PP:0, GW:0, GL:0, PTS:0 });
    state.matches.forEach(m=>{
      const {A,B,sets,ptsA,ptsB} = m; if(!stats[A]||!stats[B]) return;
      stats[A].PJ++; stats[B].PJ++; let sA=0,sB=0, gA=0,gB=0;
      (sets||[]).forEach(([a,b])=>{ if(a>b) sA++; else if(b>a) sB++; gA+=a; gB+=b; });
      stats[A].GW+=gA; stats[A].GL+=gB; stats[B].GW+=gB; stats[B].GL+=gA;
      if(sA>sB){ stats[A].PG++; stats[B].PP++; } else { stats[B].PG++; stats[A].PP++; }
      stats[A].PTS+=ptsA; stats[B].PTS+=ptsB;
    });
    // Orden: PG desc, luego GW desc, luego PTS desc
    const arr = state.teams.map(t=>stats[t.id]).filter(Boolean)
      .sort((x,y)=> (y.PG-x.PG) || (y.GW-x.GW) || (y.PTS-x.PTS));
    $('#standings tbody').innerHTML = arr.map((r,i)=>`
      <tr>
        <td>${i+1}</td><td>${escapeHtml(r.name)}</td>
        <td>${r.PJ}</td><td>${r.PG}</td><td>${r.PP}</td>
        <td>${r.GW}</td><td>${r.GL}</td><td>${r.GW-r.GL}</td>
        <td><strong>${(Math.round(r.PTS*10)/10).toFixed(1).replace('.0','')}</strong></td>
      </tr>`).join('') || `<tr><td colspan="9" class="small">Sin datos</td></tr>`;
  }
  </script>
</body>
</html>
