function matchCard(a,b,leg,ri,idx){
  const ia = indexOfTeam(a), ib = indexOfTeam(b);
  const aId = (ia <= ib) ? a : b, bId = (ia <= ib) ? b : a;
  const A = escapeHtml(teamName(aId)), B = escapeHtml(teamName(bId));

  // Formato de uniq respetando tu esquema original
  const uniq = [aId,bId].slice().sort().join('__') + '_' + leg + '_' + ri + '_' + idx;

  // Buscar si ya existe en Supabase para precargar valores
  const existing = state && state.matches ? state.matches.find(m=>m.uniq===uniq) : null;
  const sets = (existing && Array.isArray(existing.sets)) ? existing.sets : [];

  const val = (s, side) => (sets[s] && sets[s][side]) || '';

  const input = (setIdx, sideLetter) => {
    const sideIdx = (sideLetter === 'a') ? 0 : 1;
    const v = val(setIdx, sideIdx);
    const id = `${uniq}_s${setIdx+1}${sideLetter}`;
    return `<input class="setBox" id="${id}" type="number" min="0" inputmode="numeric" value="${v}">`;
  };

  return `<div class="match">
    <div class="small"><b>${A}</b> vs <b>${B}</b></div>

    <!-- Fila A: A1, A2, A3 -->
    <div class="row-score">
      <span>${A}</span>
      ${input(0,'a')}
      ${input(1,'a')}
      ${input(2,'a')}
    </div>

    <!-- Fila B: B1, B2, B3 -->
    <div class="row-score">
      <span>${B}</span>
      ${input(0,'b')}
      ${input(1,'b')}
      ${input(2,'b')}
    </div>

    <div class="actions" style="margin-top:6px">
      <button class="primary" onclick="saveMatch('${uniq}','${aId}','${bId}','${leg}',${ri},${idx})">Guardar</button>
      <button class="ghost" onclick="deleteMatch('${uniq}')">Borrar</button>
    </div>
  </div>`;
}

function renderLeg(container, rounds, leg){
  const root = document.querySelector(container);
  const filt = $('#filterTeam') ? $('#filterTeam').value : 'ALL';
  const list = rounds.map((games,ri)=> games.map((g,idx)=>({ri,idx,g}))).flat();
  const filtered = (filt==='ALL') ? list : list.filter(({g:[x,y]})=> x===filt || y===filt);

  root.innerHTML = filtered.map(({ri,idx,g:[a,b]})=> matchCard(a,b,leg,ri,idx)).join('')
                   || '<div class="small">(sin partidos)</div>';

  // Enlazar auto-avance de foco en orden A1 ‚Üí A2 ‚Üí A3 ‚Üí B1 ‚Üí B2 ‚Üí B3
  bindAutoAdvance(root);
}

function bindAutoAdvance(scope){
  // Por cada tarjeta de partido armamos la secuencia exacta
  const cards = scope.querySelectorAll('.match');
  cards.forEach(card=>{
    // Encuentra los IDs presentes dentro de esta card
    const allInputs = Array.from(card.querySelectorAll('input.setBox'));
    if(allInputs.length === 0) return;

    // Construimos la lista en orden de foco solicitado: A1,A2,A3,B1,B2,B3
    const ids = allInputs.map(el => el.id);
    const uniqPrefix = ids[0].split('_s')[0]; // "pair_leg_ri_idx"

    const seqIds = [
      `${uniqPrefix}_s1a`, `${uniqPrefix}_s2a`, `${uniqPrefix}_s3a`,
      `${uniqPrefix}_s1b`, `${uniqPrefix}_s2b`, `${uniqPrefix}_s3b`,
    ];

    // Filtrar por si falta alg√∫n set (igual mantiene el orden)
    const seq = seqIds
      .map(id => card.querySelector(`#${CSS.escape(id)}`))
      .filter(Boolean);

    seq.forEach((el, i) => {
      el.addEventListener('input', () => {
        if (String(el.value).length >= 1) {
          const next = seq[i+1];
          if (next) next.focus();
        }
      });
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const next = seq[i+1];
          if (next) next.focus();
        }
        if (e.key === 'ArrowLeft' && el.selectionStart === 0) {
          const prev = seq[i-1];
          if (prev) { e.preventDefault(); prev.focus(); }
        }
        if (e.key === 'ArrowRight' && el.selectionStart === String(el.value).length) {
          const next = seq[i+1];
          if (next) { e.preventDefault(); next.focus(); }
        }
      });
    });
  });
}

window.saveMatch = async (uniq, a, b, leg, ri, idx)=>{
  // Leer por IDs (A1,A2,A3,B1,B2,B3) para evitar des-orden
  const get = (id) => document.getElementById(id);
  const A1 = Number(get(`${uniq}_s1a`)?.value || 0);
  const A2 = Number(get(`${uniq}_s2a`)?.value || 0);
  const A3 = Number(get(`${uniq}_s3a`)?.value || 0);
  const B1 = Number(get(`${uniq}_s1b`)?.value || 0);
  const B2 = Number(get(`${uniq}_s2b`)?.value || 0);
  const B3 = Number(get(`${uniq}_s3b`)?.value || 0);

  // Armar sets solo con los que tengan datos
  const rawSets = [[A1,B1],[A2,B2],[A3,B3]];
  const sets = rawSets.filter(([x,y]) => (x>0 || y>0));

  if (sets.length < 2) { alert('Carga al menos dos sets'); return; }

  let sa = 0, sb = 0;
  sets.forEach(([x,y])=>{ if(x>y) sa++; else if(y>x) sb++; });
  if (sa === sb && sets.length < 3) { alert('Falta el 3er set'); return; }

  const pts_a = sa > sb ? 3 : 0;
  const pts_b = sb > sa ? 3 : 0;

  const payload = {
    league_id: LEAGUE_ID,
    uniq, leg, round: ri + 1,
    team_a: a, team_b: b,
    sets, pts_a, pts_b
  };

  const { error } = await supabase.from('matches').upsert(payload).select('*').single();
  if (error) { console.error('upsert error', error); alert('No se pudo guardar el partido'); return; }

  // Recargar listas para reflejar tabla/fixture
  await reloadAll();
};
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Liga Femenina ‚Äì No puedo, tengo p√°del</title>
<style>
:root{
 --bg:#f7f9fb; --panel:#ffffff; --text:#0f1220; --muted:#5d667b; --border:#e6e9ef;
 --accent:#2dd24c; --accent-ink:#0a1b10; --danger:#ff5470; --ok:#22c55e; --chip:#f0f3f8; --line:#dfe4ec;
}
*{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;background:var(--bg);color:var(--text)}
h1,h2{margin:.2rem 0} h1{font-size:clamp(1.4rem,2.3vw,2.2rem)}
.container{max-width:1100px;margin:0 auto;padding:20px}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 20px rgba(16,24,40,.04)}
.card .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
.card .bd{padding:14px 16px}
.card.togglable .hd{cursor:pointer}
.card.is-collapsed .bd{display:none}

.pill{display:inline-flex;gap:.5rem;align-items:center;padding:.35rem .7rem;border-radius:999px;background:var(--chip);color:#3b4252;font-size:.85rem;border:1px solid var(--border)}
input,select,button{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#111;outline:none}
input[type='text'],input[type='number'],select,button{width:100%}
.actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.primary{background:var(--accent);color:var(--accent-ink);border:none;font-weight:700}
.ghost{background:#fff}
.danger{background:var(--danger);color:#fff;border:none}
.ok{background:var(--ok);color:#0c1b10;border:none}
.small{font-size:.85rem;color:var(--muted)}

#teamList .row{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px dashed var(--border)}
#teamList .row:last-child{border-bottom:0}

/* Cruces (colapsable) */
details.cruces{border:1px dashed var(--border);border-radius:12px;padding:8px 10px;background:#fff}
details.cruces>summary{cursor:pointer;list-style:none;font-weight:700}
details.cruces>summary::-webkit-details-marker{display:none}

/* Cruces ‚Äì tarjetas bonitas en grilla */
.fixture-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
@media (max-width:1024px){.fixture-grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:560px){.fixture-grid{grid-template-columns:1fr}}
.fx-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.04)}
.fx-card b{display:block;margin:6px 0}

/* Juegos (cargar resultados) */
.lanes{display:grid;gap:12px}
.match{position:relative;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.03)}
.row-score{display:grid;grid-template-columns:minmax(140px,1fr) 56px 56px 56px;gap:8px;align-items:center;margin-top:6px}
.setBox{width:56px;height:48px;border:1px solid var(--border);border-radius:10px;font-size:22px;text-align:center;font-weight:700}
@media (max-width:640px){.row-score{grid-template-columns:minmax(120px,1fr) 52px 52px 52px}.setBox{width:52px;height:46px;font-size:20px}}

table{width:100%;border-collapse:collapse}
th,td{padding:8px 6px;border-bottom:1px solid var(--border);text-align:left}
th{position:sticky;top:0;background:var(--panel)}
</style>
</head>
<body>
<div class="container">
  <header class="flex" style="justify-content:space-between;align-items:flex-start;gap:16px;margin-bottom:12px">
    <div>
      <h1>üèÜ Liga Femenina ‚Äì <span style="color:#10b981">No puedo, tengo p√°del</span></h1>
      <div class="small">Supabase (sin cach√©). Cruces, juegos y tabla.</div>
    </div>
    <div class="pill" id="connBadge">üåê Supabase</div>
  </header>

  <nav class="actions" style="margin-bottom:6px">
    <label class="small">Pareja:
      <select id="filterTeam" style="width:auto;min-width:180px"><option value="ALL">Todas</option></select>
    </label>
  </nav>

  <!-- PAREJAS -->
  <section class="grid">
    <div class="card togglable is-collapsed" id="pairsCard">
      <div class="hd"><strong>üë• Parejas / Jugadoras</strong></div>
      <div class="bd"><div id="teamList"></div></div>
    </div>
  </section>

  <!-- CRUCES (bonitos) -->
  <section class="grid">
    <div class="card togglable is-collapsed" id="crucesCard">
      <div class="hd">
        <strong>üéæ Cruces</strong>
        <div class="small" id="fixtureInfo"></div>
      </div>
      <div class="bd">
        <details class="cruces" id="block-ida"><summary>IDA</summary>
          <div class="fixture-grid" id="fixture-ida"></div>
        </details>
        <details class="cruces" id="block-vuelta" style="margin-top:12px"><summary>VUELTA</summary>
          <div class="fixture-grid" id="fixture-vuelta"></div>
        </details>
      </div>
    </div>
  </section>

  <!-- JUEGOS (cargar resultados) -->
  <section class="grid">
    <div class="card togglable is-collapsed" id="gamesCard">
      <div class="hd"><strong>üìù Juegos (cargar resultados)</strong></div>
      <div class="bd">
        <details id="games-ida"><summary><b>IDA</b></summary><div class="lanes" id="lanes-ida"></div></details><br>
        <details id="games-vuelta"><summary><b>VUELTA</b></summary><div class="lanes" id="lanes-vuelta"></div></details>
      </div>
    </div>
  </section>

  <!-- TABLA (siempre visible) -->
  <section class="grid">
    <div class="card">
      <div class="hd">
        <strong>üìä Tabla de posiciones</strong>
        <div class="actions"><button id="resetLocal" class="danger" style="display:none">Reiniciar cache</button></div>
      </div>
      <div class="bd">
        <div style="overflow:auto">
          <table id="standings"><thead><tr>
            <th>#</th><th>Pareja</th><th>PJ</th><th>PG</th><th>PP</th><th>Games +</th><th>Games ‚àí</th><th>Dif</th><th>Puntos</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </section>

  <footer class="flex" style="justify-content:space-between;gap:8px;flex-wrap:wrap;margin-top:6px">
    <div class="small">Reglas: Victoria = <strong>3 pts</strong> ‚Ä¢ Derrota = <strong>0 pts</strong>.</div>
    <a class="pill" href="index.html">üîê Salir / Login</a>
  </footer>
</div>

<script type="module">
/* ========= SUPABASE ========= */
const SUPABASE_URL = 'https://dyaptlmncbbmruyduerv.supabase.co';
const SUPABASE_ANON_KEY =
 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5YXB0bG1uY2JibXJ1eWR1ZXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1Nzc0MjgsImV4cCI6MjA3NjE1MzQyOH0.5bSZuq8G1XW3LYoM92J5skRuUpnUQYbd_oKT3toTSlA';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const LEAGUE_ID = 'lfnpd-2025';

const $ = (s,r=document)=>r.querySelector(s);
let teams = [];
let matches = [];
let fixture = { ida: [], vuelta: [] };

init();

async function init(){
  restoreCollapsers();
  await loadAll();
  bindUI();
}

function restoreCollapsers(){
  // Si quieres persistir estado abierto/cerrado, puedes usar localStorage aqu√≠
  // Por ahora los dejo colapsados por defecto como pediste.
}

/* ====== LOAD ====== */
async function loadAll(){
  try{
    const { data: t, error: te } = await sb
      .from('teams').select('*').eq('league_id', LEAGUE_ID).order('position');
    if(te) throw te;
    teams = (t||[]).map(x=>({ id:x.id, name:x.name, position:x.position }));

    const { data: m, error: me } = await sb
      .from('matches').select('*').eq('league_id', LEAGUE_ID);
    if(me) throw me;
    matches = (m||[]).map(x=>({
      id:x.id, uniq:x.uniq, leg:x.leg, round:x.round,
      team_a:x.team_a, team_b:x.team_b,
      sets: Array.isArray(x.sets)? x.sets : [],
      pts_a: Number(x.pts_a||0), pts_b: Number(x.pts_b||0),
      date: x.date||null
    }));

    buildFixture();
    renderTeams();
    populateTeamFilter();
    renderFixture();
    renderGames();
    renderStandings();
  }catch(e){
    console.error('Error cargando Supabase:', e);
    alert('No se pudieron cargar datos de Supabase. Revisa consola/RLS.');
  }
}

/* ====== FIXTURE (Round Robin) ====== */
function buildFixture(){
  const ids = teams.map(t=>t.id);
  const arr = ids.slice();
  if(arr.length%2===1) arr.push('BYE');
  const n = arr.length;
  const rounds=[];
  for(let r=0;r<n-1;r++){
    const round=[];
    for(let i=0;i<n/2;i++){
      const a=arr[i], b=arr[n-1-i];
      if(a!=='BYE' && b!=='BYE') round.push([a,b]);
    }
    rounds.push(round);
    arr.splice(1,0,arr.pop());
  }
  fixture.ida = rounds;
  fixture.vuelta = rounds.map(rd=> rd.map(([a,b])=>[b,a]));
}

/* ====== UI BIND ====== */
function bindUI(){
  $('#pairsCard .hd').addEventListener('click', ()=> $('#pairsCard').classList.toggle('is-collapsed'));
  $('#crucesCard .hd').addEventListener('click', ()=> $('#crucesCard').classList.toggle('is-collapsed'));
  $('#gamesCard .hd').addEventListener('click', ()=> $('#gamesCard').classList.toggle('is-collapsed'));
  $('#filterTeam').addEventListener('change', ()=>{ renderGames(); });
}

/* ====== TEAMS ====== */
function renderTeams(){
  $('#teamList').innerHTML = teams.map((t,i)=>`
    <div class="row">
      <div style="flex:1 1 auto"><strong>${escape(t.name)}</strong> <span class="small">¬∑ #${i+1}</span></div>
      <div class="actions" style="flex:0 0 auto">
        <!-- En esta versi√≥n no movemos/insertamos, solo mostramos -->
      </div>
    </div>`).join('') || '<span class="small">Sin parejas</span>';
}

function populateTeamFilter(){
  $('#filterTeam').innerHTML = '<option value="ALL">Todas</option>' +
    teams.map(t=>`<option value="${t.id}">${escape(t.name)}</option>`).join('');
}

/* ====== CRUCES (bonitos) ====== */
function renderFixture(){
  const ida = fixture.ida.flat();
  const vuelta = fixture.vuelta.flat();
  const nTeams = teams.length;
  const perLeg = nTeams*(nTeams-1)/2;
  $('#fixtureInfo').textContent = `Parejas: ${nTeams} ¬∑ Partidos por fase: ${perLeg}`;

  $('#fixture-ida').innerHTML = ida.map(([a,b])=> fxCard(a,b)).join('') || '<div class="small">(sin cruces)</div>';
  $('#fixture-vuelta').innerHTML = vuelta.map(([a,b])=> fxCard(a,b)).join('') || '<div class="small">(sin cruces)</div>';
}
function fxCard(a,b){
  return `<div class="fx-card">${escape(nm(a))}<b>vs</b>${escape(nm(b))}</div>`;
}

/* ====== JUEGOS ====== */
function renderGames(){
  renderLeg('#lanes-ida', fixture.ida, 'ida');
  renderLeg('#lanes-vuelta', fixture.vuelta, 'vuelta');
}

function renderLeg(container, rounds, leg){
  const root = document.querySelector(container);
  const filt = $('#filterTeam').value || 'ALL';
  const list = rounds.map((games,ri)=> games.map((g,idx)=>({ri,idx,g}))).flat();
  const filtered = (filt==='ALL') ? list : list.filter(({g:[x,y]})=> x===filt || y===filt);
  root.innerHTML = filtered.map(({ri,idx,g:[a,b]})=> matchCard(a,b,leg,ri,idx)).join('') || '<div class="small">(sin partidos)</div>';
}

function matchCard(a,b,leg,ri,idx){
  const uniq = `${[a,b].slice().sort().join('__')}_${leg}_${ri}_${idx}`; // ‚¨ÖÔ∏è formato original
  const rec = matches.find(m=>m.uniq===uniq);
  const val = (s,p)=> rec?.sets?.[s]?.[p] ?? '';
  const input=(s,p)=>`<input class="setBox" data-u="${uniq}" data-s="${s}" data-p="${p}" value="${val(s,p)}">`;
  return `<div class="match">
    <div class="small"><b>${escape(nm(a))}</b> vs <b>${escape(nm(b))}</b></div>
    <div class="row-score"><span>${escape(nm(a))}</span>${input(0,0)}${input(1,0)}${input(2,0)}</div>
    <div class="row-score"><span>${escape(nm(b))}</span>${input(0,1)}${input(1,1)}${input(2,1)}</div>
    <div class="actions" style="margin-top:6px">
      <button class="primary" onclick="saveMatch('${uniq}','${a}','${b}','${leg}',${ri},${idx})">Guardar</button>
      <button class="ghost" onclick="deleteMatch('${uniq}')">Borrar</button>
    </div>
  </div>`;
}

window.saveMatch = async(uniq,a,b,leg,ri,idx)=>{
  const fields = [...document.querySelectorAll(`[data-u="${uniq}"]`)];
  const sets = [[0,1],[2,3],[4,5]].map((_,s)=>[
    Number(fields[s*2]?.value)||0, Number(fields[s*2+1]?.value)||0
  ]).filter(x=>x[0]>0||x[1]>0);

  if(sets.length<2){ alert('Carga al menos dos sets'); return; }
  let sa=0,sb=0; sets.forEach(([x,y])=>{ if(x>y) sa++; else if(y>x) sb++; });
  if(sa===sb && sets.length<3){ alert('Falta el 3er set'); return; }
  const pts_a = sa>sb?3:0, pts_b = sb>sa?3:0;

  const payload = {
    league_id: LEAGUE_ID, uniq,
    leg, round: ri+1, team_a:a, team_b:b,
    sets, pts_a, pts_b
  };
  const { error } = await sb.from('matches').upsert(payload).select('*').single();
  if(error){ console.error('upsert error', error); alert('No se pudo guardar el partido'); return; }
  await loadAll();
}

window.deleteMatch = async(uniq)=>{
  const { error } = await sb.from('matches').delete().eq('uniq', uniq).eq('league_id', LEAGUE_ID);
  if(error){ console.error('delete error', error); alert('No se pudo borrar'); return; }
  await loadAll();
}

/* ====== STANDINGS ====== */
function renderStandings(){
  const stats={};
  teams.forEach(t=> stats[t.id]={ name:t.name,PJ:0,PG:0,PP:0,GW:0,GL:0,PTS:0 });

  matches.forEach(m=>{
    const A=m.team_a, B=m.team_b; if(!stats[A]||!stats[B]) return;
    let sA=0,sB=0,gA=0,gB=0;
    (m.sets||[]).forEach(([x,y])=>{ gA+=x; gB+=y; if(x>y) sA++; else if(y>x) sB++; });
    stats[A].PJ++; stats[B].PJ++;
    stats[A].GW+=gA; stats[A].GL+=gB; stats[B].GW+=gB; stats[B].GL+=gA;
    if(sA>sB){ stats[A].PG++; stats[B].PP++; } else { stats[B].PG++; stats[A].PP++; }
    stats[A].PTS += (m.pts_a||0); stats[B].PTS += (m.pts_b||0);
  });

  const arr = Object.entries(stats).map(([id,s])=>({id,...s}))
    .sort((x,y)=> (y.PTS-x.PTS) || (y.GW-x.GW));

  $('#standings tbody').innerHTML = arr.map((r,i)=>`
    <tr><td>${i+1}</td><td>${escape(r.name)}</td><td>${r.PJ}</td><td>${r.PG}</td><td>${r.PP}</td>
    <td>${r.GW}</td><td>${r.GL}</td><td>${r.GW-r.GL}</td><td><strong>${r.PTS}</strong></td></tr>
  `).join('') || `<tr><td colspan="9" class="small">Sin datos</td></tr>`;
}

/* ====== utils ====== */
function nm(id){ return teams.find(t=>t.id===id)?.name || '¬ø?'; }
function escape(s){ return String(s).replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]||ch)); }
</script>
</body>
</html>
