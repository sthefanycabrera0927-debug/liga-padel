<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Liga Femenina â€“ No puedo, tengo pÃ¡del</title>
  <meta name="theme-color" content="#ffffff">
  <style>
    :root{
      --bg:#f6f8fb; --panel:#ffffff; --text:#0e1325; --muted:#606b7f; --border:#e6eaf1;
      --accent:#22c55e; --accent-ink:#052e1a; --danger:#ef4444; --ok:#22c55e; --warn:#f59e0b;
      --chip:#f1f5f9; --ink-strong:#0a0f1e; --shadow:0 6px 24px rgba(16,24,40,.06); --radius:16px;
    }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
      background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      font-size:14.25px;
    }
    strong{ font-weight:600 } h1,h2{ margin:.2rem 0 }
    h1{ font-size:clamp(1.15rem,2vw,1.8rem); color:var(--ink-strong); font-weight:700 }
    .container{ max-width:1100px; margin:0 auto; padding:20px }
    .grid{ display:grid; grid-template-columns:1fr; gap:16px }

    .card{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow) }
    .card .hd{
      display:flex; align-items:center; justify-content:space-between; padding:10px 14px;
      border-bottom:1px solid var(--border); font-size:.94rem; user-select:none;
    }
    .card .hd button, .card .hd input, .card .hd select, .card .hd a{ pointer-events:auto }
    .card .bd{ padding:12px 14px }
    .card.is-collapsed .bd{ display:none }
    .card.togglable .hd{ cursor:pointer }

    .pill{
      display:inline-flex; gap:.45rem; align-items:center; padding:.28rem .55rem;
      border-radius:999px; background:var(--chip); color:#0c1529; font-size:.8rem; border:1px solid var(--border);
      white-space:nowrap;
    }
    input,select,button{
      padding:8px 10px; border-radius:10px; border:1px solid var(--border);
      background:#fff; color:#0f1220; outline:none; font-size:.9rem;
    }
    input[type='text'], input[type='number'], select, button{ width:100% }
    input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
    input[type=number]{ -moz-appearance:textfield }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .primary{ background:var(--accent); color:var(--accent-ink); border:none; font-weight:700 }
    .ghost{ background:#fff } .danger{ background:var(--danger); color:#fff; border:none }
    .ok{ background:var(--ok); color:#052e1a; border:none; font-weight:700 }
    .icon-btn{
      width:36px; height:36px; border:1px solid var(--border); border-radius:10px; background:#fff;
      display:inline-flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer;
    }
    .icon-btn:hover{ box-shadow:0 0 0 2px rgba(0,0,0,.03) inset }

    table{ width:100%; border-collapse:collapse; min-width:560px; font-size:.92rem }
    th,td{ padding:8px 8px; border-bottom:1px solid var(--border); text-align:left }
    th{ position:sticky; top:0; background:var(--panel); z-index:1 }
    .small{ font-size:.8rem; color:var(--muted) }

    /* ===== Tabs mÃ³viles: SOLO en mobile ===== */
    .mobile-tabs{ display:none } /* default: oculto (desktop) */
    .mobile-section{ display:block }
    @media (max-width: 820px){
      .mobile-tabs{
        display:flex; position:sticky; top:0; z-index:5; gap:8px; padding:8px;
        background:linear-gradient(#f6f8fb,#f6f8fb);
      }
      .mobile-tabs button{
        flex:1; display:flex; align-items:center; justify-content:center; gap:6px;
        border-radius:999px; border:1px solid var(--border); background:#fff;
        font-weight:700; font-size:.95rem; padding:10px 12px; box-shadow:0 1px 0 rgba(16,24,40,.03);
      }
      .mobile-tabs button.active{ background:var(--ok); color:var(--accent-ink); border-color:transparent }
      .mobile-section{ display:none } .mobile-section.active{ display:block }
    }

    .flash{ box-shadow:0 0 0 3px var(--accent) inset }

    /* ===== Tarjetas de cruces ===== */
    .games-grid{
      display:grid; gap:12px; margin-top:10px;
      grid-template-columns:repeat(2, minmax(320px, 1fr));
    }
    @media (max-width: 960px){ .games-grid{ grid-template-columns:1fr } }

    details.match{
      border:1px solid #e8eef6; border-radius:16px; background:#fff; overflow:hidden;
      transition:box-shadow .15s ease, border-color .15s ease;
    }
    details.match > summary{
      list-style:none; cursor:pointer; padding:12px 14px; display:flex; align-items:center; gap:12px; background:#f9fafb;
    }
    details.match > summary::-webkit-details-marker{ display:none }
    details.match:hover{ border-color:#d8e6f8 }
    details.match[open]{ box-shadow:0 10px 26px rgba(16,24,40,.10); border-color:#cfe2fb; position:relative }
    details.match[open]::before{ content:""; position:absolute; inset:0 0 0 auto; left:0; width:4px; border-radius:16px 0 0 16px; background:var(--ok) }
    .badge-done{ background:#eaffef; border:1px solid #bfeacb; color:#075a2a }
    .match.done{ border-left:4px solid var(--ok) }

    .mhd{ display:flex; align-items:center; gap:12px; flex:1; min-width:0 }
    .mhd .badgeAB{ display:inline-flex; gap:6px }
    .mhd .names{ display:flex; flex-direction:column; min-width:0 }
    .mhd .names .line{ display:flex; gap:8px; align-items:center; min-width:0; font-size:1rem; color:#0b1227; font-weight:800 }
    .mhd .names .line strong{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:44ch }
    .mhd .vs{ margin:0 4px; opacity:.35; font-weight:800 }
    .mhd .meta{ margin-left:auto; display:flex; gap:6px; align-items:center; flex-wrap:wrap }
    .m-bd{ padding:12px 14px; background:linear-gradient(180deg,#fff,#fbfdff) }

    /* Sets */
    .score-row{
      display:grid; grid-template-columns:1fr repeat(3,58px); gap:8px; align-items:center; padding:6px 0;
    }
    .score-row + .score-row{ border-top:1px solid var(--border) }
    .player-name{ font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#0a1228; font-size:.95rem }
    .setBox{
      width:58px; height:46px; border:1px solid var(--border); border-radius:10px;
      font-size:20px; text-align:center; font-weight:700; letter-spacing:.2px; box-shadow:inset 0 1px 0 rgba(0,0,0,.03);
    }

    /* ===== MODO MÃ“VIL: header de tarjeta en dos lÃ­neas y chips compactas ===== */
    @media (max-width: 600px){
      details.match > summary{
        padding:10px 12px; align-items:flex-start; gap:10px;
        /* apilamos nombre + chips */
        flex-direction:column;
      }
      .mhd{ width:100%; gap:8px }
      .mhd .badgeAB{ display:none } /* menos ruido */
      .mhd .names .line{ font-size:1rem }
      .mhd .names .line strong{ max-width:22ch } /* cortes mÃ¡s agresivos */
      .mhd .meta{
        margin-left:0;
        width:100%;
        gap:6px;
      }
      .pill{ font-size:.74rem; padding:.22rem .46rem }
      .setBox{ width:52px; height:42px; font-size:18px }
      .score-row{ grid-template-columns:1fr repeat(3,48px); gap:6px }
    }

    /* Sub-colapsables por leg */
    details.leg{ border:1px dashed var(--border); border-radius:12px; padding:6px 8px; margin-bottom:10px; background:#fff }
    details.leg>summary{ list-style:none; cursor:pointer; display:flex; align-items:center; gap:8px; font-weight:700 }
    details.leg>summary::-webkit-details-marker{ display:none }
  </style>
</head>
<body>
  <div class="container">
    <header class="flex" style="justify-content:space-between; align-items:flex-start; gap:16px; margin-bottom:12px">
      <div>
        <h1>ğŸ† Liga Femenina â€“ <span style="color:#10b981">No puedo, tengo pÃ¡del</span></h1>
        <div class="small">Supabase + cachÃ© local. Ida/Vuelta, resultados y tabla.</div>
      </div>
      <div class="pill" id="connBadge">ğŸ”Œ Local</div>
    </header>

    <nav class="mobile-tabs" id="mobileTabs">
      <button type="button" data-target="#sec-parejas" class="active">ğŸ‘¥ Parejas</button>
      <button type="button" data-target="#sec-cuadros">ğŸ¾ Partidos</button>
      <button type="button" data-target="#sec-tabla">ğŸ“Š Tabla</button>
    </nav>

    <!-- PAREJAS -->
    <section id="sec-parejas" class="grid mobile-section active">
      <div class="card togglable" id="pairsCard">
        <div class="hd" id="pairsHeader">
          <strong>â• Parejas / Jugadoras</strong>
          <span class="small">(clic para mostrar/ocultar)</span>
        </div>
        <div class="bd">
          <div class="actions">
            <input id="teamName" placeholder="Ej: Jessi/Ck" style="max-width:260px" />
            <button id="addPair" class="primary">Agregar pareja</button>
            <button id="reloadAll" class="ghost">ğŸ”„ Recargar</button>
          </div>
          <div id="teamList" class="compact-list" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- CRUCES -->
    <section id="sec-cuadros" class="grid mobile-section">
      <div class="card togglable" id="fixtureCard">
        <div class="hd" id="fixtureHeader">
          <strong>ğŸ“† Cruces</strong>
          <div class="actions" style="pointer-events:auto">
            <button id="regenFixture" class="primary">Regenerar</button>
            <label class="small">Vista:
              <select id="filterLeg" style="width:auto"><option value="ALL">Todo</option><option value="ida">Ida</option><option value="vuelta">Vuelta</option></select>
            </label>
            <label class="small">Pareja:
              <select id="filterTeam" style="width:auto; min-width:200px"><option value="ALL">Todas</option></select>
            </label>
          </div>
        </div>
        <div class="bd">
          <div class="small" style="margin-bottom:8px">Con <strong>7</strong> parejas hay <strong>21</strong> partidos por leg. Con 8 parejas, <strong>28</strong>.</div>
          <div id="fixtureInfo" class="small"></div>

          <details class="leg" id="leg-ida" open>
            <summary>ğŸ…°ï¸ IDA <span class="small" id="badgeIda"></span></summary>
            <div id="cardsIda"></div>
          </details>

          <details class="leg" id="leg-vuelta">
            <summary>ğŸ…±ï¸ VUELTA <span class="small" id="badgeVuelta"></span></summary>
            <div id="cardsVuelta"></div>
          </details>
        </div>
      </div>
    </section>

    <!-- TABLA -->
    <section id="sec-tabla" class="grid mobile-section">
      <div class="card">
        <div class="hd"><strong>ğŸ“Š Tabla de posiciones</strong></div>
        <div class="bd">
          <div style="overflow:auto">
            <table id="standings"><thead><tr>
              <th>#</th><th>Pareja</th><th>PJ</th><th>PG</th><th>PP</th><th>Games +</th><th>Games âˆ’</th><th>Dif</th><th>Puntos</th>
            </tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </section>

    <footer class="flex" style="justify-content:space-between; gap:8px; flex-wrap:wrap; margin-top:6px">
      <div class="small">Reglas: Victoria = <strong>3 pts</strong> â€¢ Derrota en 3 sets = <strong>0 pt</strong>.</div>
      <div class="pill" id="connBadgeFooter">ğŸ”Œ Local</div>
    </footer>
  </div>

  <script type="module">
  const SUPABASE_URL = 'https://dyaptlmncbbmruyduerv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5YXB0bG1uY2JibXJ1eWR1ZXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1Nzc0MjgsImV4cCI6MjA3NjE1MzQyOH0.5bSZuq8G1XW3LYoM92J5skRuUpnUQYbd_oKT3toTSlA';
  const LEAGUE_ID = 'lfnpd-2025';
  const ALLOW_PUBLIC_WRITE = true;

  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
  const hasSB = SUPABASE_URL.startsWith('http') && SUPABASE_ANON_KEY.length > 20;
  const supabase = hasSB ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

  const $ = (s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const LS_KEY = 'liga-padel-cache-v11';
  let state = loadLocal() || { teams: [], matches: [], fixtures:{ida:[],vuelta:[]}, dates:{}, showSummaryResults:false };
  const DEFAULT_TEAMS = ['Jessi/Ck','Vanessa/Auri','Patty/Vero','Valen/Sele','Enyor/Stef','Nathaly/Cristina','Nativid/Olga'];

  const connText = hasSB ? 'ğŸŒ Supabase' : 'ğŸ”Œ Local';
  $('#connBadge').textContent = connText;
  $('#connBadgeFooter').textContent = connText;

  initTabs();
  await reloadAll();
  bindUI();

  /* PAREJAS: toggle con persistencia */
  (function(){
    const card = $('#pairsCard'); const header = $('#pairsHeader'); const KEY = 'pairsCollapsed';
    const was = localStorage.getItem(KEY);
    if(was === 'true') card.classList.add('is-collapsed'); else card.classList.remove('is-collapsed');
    header.addEventListener('click', (e)=>{
      if(e.target.closest('button, input, select, a')) return;
      card.classList.toggle('is-collapsed');
      localStorage.setItem(KEY, String(card.classList.contains('is-collapsed')));
    });
  })();

  function saveLocal(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch{} }
  function loadLocal(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)); }catch{ return null; } }
  function uid(){ return Math.random().toString(36).slice(2,9); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]||ch)); }
  function teamName(id){ const t = state.teams.find(t=>t.id===id); return t? t.name : 'Â¿?'; }
  function toDateInputValue(v){ if(!v) return ''; const d=new Date(v); if(!isNaN(d)) return d.toISOString().slice(0,10); if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v; return ''; }
  function indexOfTeam(id){ return state.teams.findIndex(t=>t.id===id); }
  function orderPair(a,b){ const ia=indexOfTeam(a), ib=indexOfTeam(b); return (ia<=ib)? [a,b] : [b,a]; }
  function pairRank(a,b){ const [x,y]=orderPair(a,b); return [indexOfTeam(x), indexOfTeam(y)]; }
  function comparePairs(p1a,p1b,p2a,p2b){ const r1=pairRank(p1a,p1b), r2=pairRank(p2a,p2b); if(r1[0]!==r2[0]) return r1[0]-r2[0]; return r1[1]-r2[1]; }

  function buildRoundRobin(ids){
    const arr = ids.slice(); if(arr.length%2===1) arr.push('BYE'); const n = arr.length; const rounds=[];
    for(let r=0; r<n-1; r++){
      const round=[]; for(let i=0;i<n/2;i++){ const a=arr[i], b=arr[n-1-i]; if(a!=='BYE' && b!=='BYE') round.push([a,b]); }
      rounds.push(round); arr.splice(1,0,arr.pop());
    }
    return rounds;
  }

  async function reloadAll(){
    if(supabase){
      const { data: teams } = await supabase.from('teams').select('*').eq('league_id', LEAGUE_ID).order('position');
      if(!teams || teams.length===0){
        if(ALLOW_PUBLIC_WRITE){
          const seed = DEFAULT_TEAMS.map((name, i)=>({ name, position:i, league_id:LEAGUE_ID }));
          await supabase.from('teams').insert(seed);
          const { data: t2 } = await supabase.from('teams').select('*').eq('league_id', LEAGUE_ID).order('position');
          state.teams = (t2||[]).map(t=>({ id:t.id, name:t.name, position:t.position }));
        }else{
          state.teams = DEFAULT_TEAMS.map((name,i)=>({ id: uid(), name, position:i }));
        }
      }else{
        state.teams = teams.map(t=>({ id:t.id, name:t.name, position:t.position }));
      }
      const { data: matches } = await supabase.from('matches').select('*').eq('league_id', LEAGUE_ID);
      state.matches = (matches||[]).map(m=>({ id:m.id, uniq:m.uniq, A:m.team_a, B:m.team_b, leg:m.leg, round:m.round, sets:m.sets||[], ptsA:Number(m.pts_a||0), ptsB:Number(m.pts_b||0), date:m.date||'' }));
    }else{
      if(state.teams.length===0){ state.teams = DEFAULT_TEAMS.map((name,i)=>({ id: uid(), name, position:i })); saveLocal(); }
    }

    const ids = state.teams.map(t=>t.id);
    state.fixtures = { ida: buildRoundRobin(ids), vuelta: [] };
    state.fixtures.vuelta = state.fixtures.ida.map(r=> r.map(p=>[p[1],p[0]]));

    populateTeamFilters();
    renderTeams(); renderCards(); renderStandings();
  }

  function bindUI(){
    $('#addPair').addEventListener('click', onAddTeam);
    $('#reloadAll').addEventListener('click', reloadAll);
    $('#regenFixture').addEventListener('click', ()=>{
      const ids = state.teams.map(t=>t.id);
      state.fixtures.ida = buildRoundRobin(ids);
      state.fixtures.vuelta = state.fixtures.ida.map(r=> r.map(p=>[p[1],p[0]]));
      renderCards();
    });
    $('#filterLeg').addEventListener('change', renderCards);
    $('#filterTeam').addEventListener('change', renderCards);

    // Toggle genÃ©rico de cards
    $$('.card.togglable .hd').forEach(h=>{
      h.addEventListener('click', (e)=>{
        if(e.target.closest('button, input, select, a')) return;
        h.parentElement.classList.toggle('is-collapsed');
      });
    });

    // Tabs mÃ³viles
    const tabs = $$('#mobileTabs button');
    const sections = ['#sec-parejas','#sec-cuadros','#sec-tabla'].map(s=>$(s));
    function isMobile(){ return window.matchMedia('(max-width:820px)').matches; }
    function activate(sel){
      tabs.forEach(b=>b.classList.toggle('active', b.dataset.target===sel));
      sections.forEach(sec=> sec && (sec.classList.toggle('active','#'+sec.id===sel), sec.classList.add('mobile-section')));
    }
    tabs.forEach(btn=> btn.addEventListener('click', ()=> activate(btn.dataset.target)));
    window.addEventListener('resize', ()=>{ if(!isMobile()){ sections.forEach(sec=>sec && sec.classList.add('active')); } });
    if(isMobile()) activate('#sec-parejas'); else sections.forEach(sec=>sec && sec.classList.add('active'));
  }

  async function onAddTeam(){
    const name = $('#teamName').value.trim(); if(!name){ alert('Nombre vacÃ­o'); return; }
    if(state.teams.some(t=>t.name.toLowerCase()===name.toLowerCase())){ alert('Ya existe'); return; }
    const position = state.teams.length;
    if(supabase){
      const { data, error } = await supabase.from('teams').insert({ name, position, league_id: LEAGUE_ID }).select('*').single();
      if(error){ alert('No se pudo guardar en Supabase'); console.warn(error); return; }
      state.teams.push({ id:data.id, name:data.name, position:data.position });
    }else{
      state.teams.push({ id: uid(), name, position }); saveLocal();
    }
    $('#teamName').value=''; await reloadAll();
  }

  function renderTeams(){
    const list = $('#teamList');
    const html = state.teams.map((t,i)=>`
      <div class="row" style="align-items:center; display:flex; justify-content:space-between; gap:8px; padding:6px 0">
        <div class="col-10" style="flex:1 1 auto">
          <strong style="font-size:1rem">${escapeHtml(t.name)}</strong> <span class="small">Â· #${i+1}</span>
        </div>
        <div class="col-2 actions" style="flex:0 0 auto">
          <button class="icon-btn" title="Subir" onclick="moveTeam(${i},-1)">â†‘</button>
          <button class="icon-btn" title="Bajar" onclick="moveTeam(${i},1)">â†“</button>
          <button class="icon-btn" title="Eliminar pareja" onclick="removeTeam('${t.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>`).join('');
    list.innerHTML = html || '<span class="small">Sin parejas</span>';
    populateTeamFilters();
  }

  window.moveTeam = async (i,dir)=>{
    const j=i+dir; if(j<0 || j>=state.teams.length) return;
    const x=state.teams.splice(i,1)[0]; state.teams.splice(j,0,x);
    state.teams.forEach((t,idx)=> t.position = idx);
    if(supabase){
      await supabase.from('teams').upsert(state.teams.map(t=>({ id:t.id, position:t.position, league_id: LEAGUE_ID })));
    } else saveLocal();
    await reloadAll();
  };

  window.removeTeam = async (id)=>{
    if(!confirm('Â¿Eliminar esta pareja?')) return;
    if(supabase){
      await supabase.from('matches').delete().eq('league_id', LEAGUE_ID).or(`team_a.eq.${id},team_b.eq.${id}`);
      await supabase.from('teams').delete().eq('id', id);
    }else{
      state.teams = state.teams.filter(t=>t.id!==id);
      state.matches = state.matches.filter(m=>m.A!==id && m.B!==id);
      saveLocal();
    }
    await reloadAll();
  };

  function populateTeamFilters(){
    const ft = $('#filterTeam'); const curFt = ft?.value || 'ALL';
    const opts = ['<option value="ALL">Todas</option>'].concat(state.teams.map(t=>`<option value="${t.id}">${escapeHtml(t.name)}</option>`)).join('');
    if(ft){ ft.innerHTML = opts; if(Array.from(ft.options).some(o=>o.value===curFt)) ft.value = curFt; }
  }

  /* Helpers de marcador */
  function makeSetCells(uniq, i, sets, side){
    const val = (sets[i] && sets[i][side==='A'?0:1]) || '';
    const id  = `${uniq}_s${i+1}${side.toLowerCase()}`;
    return `<input class="setBox" id="${id}" type="number" min="0" inputmode="numeric" value="${val}">`;
  }
  function setSummaryText(sets){
    if(!sets || !sets.length) return '';
    return sets.map(ab=> `${(ab[0]||0)}-${(ab[1]||0)}`).join(', ');
  }

  /* Tarjeta individual */
  function makeCard(a,b,leg,ri,idx){
    const ia=indexOfTeam(a), ib=indexOfTeam(b); const aId=(ia<=ib)?a:b, bId=(ia<=ib)?b:a;
    const A = escapeHtml(teamName(aId)); const B = escapeHtml(teamName(bId));
    const uniq = [aId,bId].slice().sort().join('__')+'_'+leg+'_'+ri+'_'+idx;
    const existing = state.matches.find(m=>m.uniq===uniq) || {};
    const sets = existing.sets || []; const dateVal = toDateInputValue(existing.date);
    const isDone = !!existing.id || !!existing.uniq;

    const head = `
      <div class="mhd">
        <div class="badgeAB"><span class="pill">A</span><span class="pill">B</span></div>
        <div class="names">
          <div class="line"><strong>${A}</strong> <span class="vs">vs</span> <strong>${B}</strong></div>
        </div>
        <div class="meta">
          <span class="pill">${dateVal ? `ğŸ“… ${dateVal}` : `ğŸ“… sin fecha`}</span>
          ${sets.length ? `<span class="pill">ğŸ§¾ ${setSummaryText(sets)}</span>` : ``}
          ${isDone ? `<span class="pill badge-done">âœ“ Hecho</span>` : ``}
        </div>
      </div>`;

    const body = `
      <div class="m-bd">
        <div class="actions" style="justify-content:space-between; gap:8px; margin-bottom:8px">
          <label class="small" style="display:flex; align-items:center; gap:6px">
            ğŸ“… <input type="date" id="date_${uniq}" value="${dateVal||''}" style="width:auto">
          </label>
          <div class="actions" style="gap:8px">
            ${isDone ? `
              <button class="icon-btn" title="Borrar resultado" onclick="deleteMatch('${uniq}')">ğŸ—‘ï¸</button>
              <button class="icon-btn" title="Actualizar resultado" onclick="saveCard('${aId}','${bId}','${leg}',${ri},${idx})">â†»</button>
            ` : `
              <button class="ok" style="width:auto" title="Guardar" onclick="saveCard('${aId}','${bId}','${leg}',${ri},${idx})">ğŸ’¾ Guardar</button>
            `}
          </div>
        </div>
        <div class="score-row">
          <div class="player-name">A: ${A}</div>
          ${makeSetCells(uniq,0,sets,'A')}
          ${makeSetCells(uniq,1,sets,'A')}
          ${makeSetCells(uniq,2,sets,'A')}
        </div>
        <div class="score-row">
          <div class="player-name">B: ${B}</div>
          ${makeSetCells(uniq,0,sets,'B')}
          ${makeSetCells(uniq,1,sets,'B')}
          ${makeSetCells(uniq,2,sets,'B')}
        </div>
      </div>`;

    return `<details class="match ${isDone?'done':''}">
      <summary>${head}</summary>${body}
    </details>`;
  }

  function legBlock(rounds, leg){
    const teamFilter = $('#filterTeam')?.value || 'ALL';
    const pairs = rounds.flat();
    const filtered = (teamFilter==='ALL') ? pairs : pairs.filter(([x,y])=> x===teamFilter || y===teamFilter);
    const gamesSorted = filtered.slice().sort((g1,g2)=> comparePairs(g1[0],g1[1],g2[0],g2[1]));

    return gamesSorted.map((g)=>{
      let ri=0, localIdx=0, found=false;
      for(let r=0; r<rounds.length && !found; r++){
        const j = rounds[r].findIndex(p=> (p[0]===g[0] && p[1]===g[1]) || (p[0]===g[1] && p[1]===g[0]));
        if(j>-1){ ri=r; localIdx=j; found=true; }
      }
      return makeCard(g[0],g[1],leg,ri,localIdx);
    }).join('') || '<div class="small">Sin partidos</div>';
  }

  function renderCards(){
    const ida = state.fixtures.ida||[]; const vuelta = state.fixtures.vuelta||[];
    const nTeams = state.teams.length; const perLeg = nTeams*(nTeams-1)/2;
    $('#fixtureInfo').textContent = `Ida: ${ida.reduce((a,r)=>a+r.length,0)} / ${perLeg} Â· Vuelta: ${vuelta.reduce((a,r)=>a+r.length,0)} / ${perLeg}`;
    const legFilter = $('#filterLeg').value || 'ALL';
    const showIda = (legFilter==='ALL' || legFilter==='ida');
    const showVuelta = (legFilter==='ALL' || legFilter==='vuelta');

    if(showIda){ $('#cardsIda').innerHTML = `<div class="games-grid">${legBlock(ida,'ida')}</div>`; $('#badgeIda').textContent = ''; }
    else { $('#cardsIda').innerHTML=''; }
    if(showVuelta){ $('#cardsVuelta').innerHTML = `<div class="games-grid">${legBlock(vuelta,'vuelta')}</div>`; $('#badgeVuelta').textContent = ''; }
    else { $('#cardsVuelta').innerHTML=''; }

    makeAccordion('#cardsIda, #cardsVuelta');
    bindAutoAdvancePerCard('#cardsIda, #cardsVuelta');
    updateLegBadges();
    bindDateChanges();
  }

  function makeAccordion(scopeSelector){
    $$(scopeSelector).forEach(scope=>{
      scope.querySelectorAll('details.match > summary').forEach(sum=>{
        sum.addEventListener('click', ()=>{
          const details = sum.parentElement;
          setTimeout(()=>{ if(details.open){ scope.querySelectorAll('details.match').forEach(d=>{ if(d!==details) d.removeAttribute('open'); }); } }, 0);
        });
      });
    });
  }

  function bindAutoAdvancePerCard(scopeSelector){
    $$(scopeSelector).forEach(scope=>{
      scope.querySelectorAll('details.match').forEach(card=>{
        const order = [
          ...card.querySelectorAll('input[id$="_s1a"]'),
          ...card.querySelectorAll('input[id$="_s1b"]'),
          ...card.querySelectorAll('input[id$="_s2a"]'),
          ...card.querySelectorAll('input[id$="_s2b"]'),
          ...card.querySelectorAll('input[id$="_s3a"]'),
          ...card.querySelectorAll('input[id$="_s3b"]'),
        ];
        order.forEach((el,idx)=>{
          el.addEventListener('input', ()=>{ if(String(el.value).length>=1){ const n=order[idx+1]; if(n) n.focus(); } });
          el.addEventListener('keydown', (e)=>{
            if(e.key==='Enter'){ e.preventDefault(); const n=order[idx+1]; if(n) n.focus(); }
            if(e.key==='ArrowLeft' && el.selectionStart===0){ const p=order[idx-1]; if(p){ e.preventDefault(); p.focus(); } }
            if(e.key==='ArrowRight' && el.selectionStart===String(el.value).length){ const n=order[idx+1]; if(n){ e.preventDefault(); n.focus(); } }
          });
        });
      });
    });
  }

  function bindDateChanges(){
    $$('input[id^="date_"]').forEach(inp=>{
      inp.addEventListener('change', async function(){
        const uniq = this.id.replace('date_',''); const rec = state.matches.find(x=>x.uniq===uniq);
        if(rec){ rec.date = this.value || null; await upsertMatch(rec); renderCards(); }
        else{
          const pill = this.closest('details.match')?.querySelector('.meta .pill');
          if(pill) pill.textContent = this.value ? `ğŸ“… ${this.value}` : 'ğŸ“… sin fecha';
        }
      });
    });
  }

  function updateLegBadges(){
    const countForLeg = (leg)=>{
      const rounds = state.fixtures[leg]||[]; const total = rounds.reduce((a,r)=>a+r.length,0); let done=0;
      rounds.forEach((games,ri)=>{ games.forEach((g,idx)=>{
        const ia=indexOfTeam(g[0]), ib=indexOfTeam(g[1]); const aId=(ia<=ib)?g[0]:g[1], bId=(ia<=ib)?g[1]:g[0];
        const uniq = [aId,bId].slice().sort().join('__')+'_'+leg+'_'+ri+'_'+idx;
        if(state.matches.find(m=>m.uniq===uniq)) done++;
      });});
      return {done,total};
    };
    const a=countForLeg('ida'), b=countForLeg('vuelta');
    $('#badgeIda').textContent = `â€¢ Hechos ${a.done}/${a.total}`;
    $('#badgeVuelta').textContent = `â€¢ Hechos ${b.done}/${b.total}`;
  }

  window.saveCard = async (a,b,leg,ri,idx)=>{
    const pair=[a,b].slice().sort().join('__'); const uniq=`${pair}_${leg}_${ri}_${idx}`;
    const get=id=>document.getElementById(id);
    const vals=[[uniq+'_s1a',uniq+'_s1b'],[uniq+'_s2a',uniq+'_s2b'],[uniq+'_s3a',uniq+'_s3b']]
      .map(ids=>[Number(get(ids[0])?.value)||0, Number(get(ids[1])?.value)||0])
      .filter(ab=>ab[0]>0 || ab[1]>0);
    if(vals.length<2){ alert('Carga al menos dos sets'); return; }
    const sw=vals.reduce((acc,ab)=>{ if(ab[0]>ab[1]) acc.a++; else if(ab[1]>ab[0]) acc.b++; return acc; },{a:0,b:0});
    if(sw.a===sw.b && vals.length<3){ alert('Empate a sets, falta el 3er set'); return; }
    const winner=sw.a>sw.b?'A':'B'; let ptsA=0,ptsB=0; if(winner==='A'){ ptsA+=3; if(vals.length===3) ptsB+=0.5; } else { ptsB+=3; if(vals.length===3) ptsA+=0.5; }
    let rec=state.matches.find(m=>m.uniq===uniq); const dateInput=document.getElementById(`date_${uniq}`); const chosenDate=dateInput?.value || (rec && rec.date) || null;
    const base={ uniq, A:a, B:b, leg, round:ri+1, sets:vals, ptsA, ptsB, date:chosenDate };
    if(rec){ Object.assign(rec, base); } else { rec={ id:uid(), ...base }; state.matches.push(rec); }
    await upsertMatch(rec); renderStandings(); renderCards();
  };

  async function upsertMatch(rec){
    if(supabase){
      const payload={ league_id:LEAGUE_ID, uniq:rec.uniq, leg:rec.leg, round:rec.round,
        team_a:rec.A, team_b:rec.B, date:rec.date, wo:false, sets:rec.sets, pts_a:rec.ptsA, pts_b:rec.ptsB };
      const { data, error } = await supabase.from('matches').upsert(payload).select('*').single();
      if(error){ console.warn(error); alert('No se pudo guardar en Supabase'); } else { rec.id=data.id; }
    } else saveLocal();
  }

  window.deleteMatch = async (uniq)=>{
    const rec = state.matches.find(m=>m.uniq===uniq); if(!rec) return;
    if(!confirm(`Â¿Eliminar resultado de ${teamName(rec.A)} vs ${teamName(rec.B)}?`)) return;
    if(supabase){
      const { error } = await supabase.from('matches').delete().eq('league_id', LEAGUE_ID).eq('uniq', uniq);
      if(error){ console.warn(error); alert('No se pudo eliminar en Supabase'); return; }
    }
    state.matches = state.matches.filter(m=>m.uniq!==uniq); saveLocal();
    renderStandings(); renderCards();
  };

  function renderStandings(){
    const stats={}; state.teams.forEach(t=> stats[t.id]={ id:t.id, name:t.name, PJ:0, PG:0, PP:0, GW:0, GL:0, PTS:0 });
    state.matches.forEach(m=>{
      const {A,B,sets,ptsA,ptsB}=m; if(!stats[A]||!stats[B]) return;
      stats[A].PJ++; stats[B].PJ++; let sA=0,sB=0, gA=0,gB=0;
      sets.forEach(ab=>{ const a=(ab&&ab[0])||0; const b=(ab&&ab[1])||0; if(a>b) sA++; else if(b>a) sB++; gA+=a; gB+=b; });
      stats[A].GW+=gA; stats[A].GL+=gB; stats[B].GW+=gB; stats[B].GL+=gA;
      if(sA>sB){ stats[A].PG++; stats[B].PP++; } else { stats[B].PG++; stats[A].PP++; }
      stats[A].PTS+=ptsA; stats[B].PTS+=ptsB;
    });
    const arr = state.teams.map(t=>stats[t.id]).filter(Boolean)
      .sort((x,y)=> (y.PG-x.PG) || (y.GW-x.GW) || (y.PTS-x.PTS));
    $('#standings tbody').innerHTML = arr.map((r,i)=>`<tr><td>${i+1}</td><td>${escapeHtml(r.name)}</td><td>${r.PJ}</td><td>${r.PG}</td><td>${r.PP}</td><td>${r.GW}</td><td>${r.GL}</td><td>${r.GW-r.GL}</td><td><strong>${(Math.round(r.PTS*10)/10).toFixed(1).replace('.0','')}</strong></td></tr>`).join('')
      || `<tr><td colspan="9" class="small">Sin datos</td></tr>`;
  }

  function initTabs(){
    const tabs = $$('#mobileTabs button');
    const sections = ['#sec-parejas','#sec-cuadros','#sec-tabla'].map(s=>$(s));
    function isMobile(){ return window.matchMedia('(max-width:820px)').matches; }
    function activate(sel){ tabs.forEach(b=>b.classList.toggle('active', b.dataset.target===sel)); sections.forEach(sec=> sec && (sec.classList.toggle('active','#'+sec.id===sel), sec.classList.add('mobile-section'))); }
    tabs.forEach(btn=> btn.addEventListener('click', ()=> activate(btn.dataset.target)));
    window.addEventListener('resize', ()=>{ if(!isMobile()){ sections.forEach(sec=>sec && sec.classList.add('active')); } });
    if(isMobile()) activate('#sec-parejas'); else sections.forEach(sec=>sec && sec.classList.add('active'));
  }
  </script>
</body>
</html>
