<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Liga Femenina – No puedo, tengo pádel</title>
  <meta name="theme-color" content="#0f1115">
  <style>
    :root{ --bg:#0f1115; --panel:#161a22; --panel-2:#1e2430; --text:#f7f7f7; --muted:#b9c0d0; --accent:#ccff00; --danger:#ff5470; --ok:#32d296; --warn:#ffc107; }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial; background:linear-gradient(180deg,#0b0e13 0%, #111521 100%); color:var(--text)}
    h1,h2{margin:.2rem 0} h1{font-size:clamp(1.4rem,2.3vw,2.2rem)}
    .container{max-width:1100px; margin:0 auto; padding:20px}
    .grid{display:grid; grid-template-columns: 1fr; gap:16px}
    .card{background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%); border:1px solid #232a38; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card .hd{display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #222a36}
    .card .bd{padding:14px 16px}
    .pill{display:inline-flex; gap:.5rem; align-items:center; padding:.35rem .7rem; border-radius:999px; background:#1a202e; color:#b9c0d0; font-size:.85rem}
    input,select,button{padding:8px 10px; border-radius:10px; border:1px solid #2a3242; background:#131824; color:#f0f3fa; outline:none}
    input[type='text'], input[type='number'], select, button{width:100%}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .primary{background:var(--accent); color:#0b0e13; border:none} .ghost{background:#121724} .danger{background:var(--danger); border:none} .ok{background:#32d296; color:#08130e}
    table{width:100%; border-collapse:collapse} th,td{padding:8px 6px; border-bottom:1px solid #252c3a; text-align:left} th{position:sticky; top:0; background:var(--panel)}
    .small{font-size:.85rem; color:#a8b2c6} .num{width:48px}
    .match-head{display:flex; flex-direction:column; gap:8px}
    .mh-title{text-align:center; font-weight:600; display:inline-flex; gap:12px; align-items:center}
    .mh-title .lab{background:#202a3b; padding:.2rem .5rem; border-radius:8px; font-weight:700; opacity:.9}
    .mh-date{display:flex; justify-content:flex-end} .mh-date input{width:auto; min-width:130px}
    .sum-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:12px}
    .sum-card{border:1px solid #2a3242; border-radius:12px; padding:12px}
    .sum-card--ida{border-color:#2b6cb0; background:linear-gradient(180deg,#0f1a28 0%, #121a2a 100%)}
    .sum-card--vuelta{border-color:#2b7a0b; background:linear-gradient(180deg,#0f1f14 0%, #142116 100%)}
    .pill-match{display:flex; flex-direction:column; gap:6px; border:1px solid #2a3242; background:#0f1422; padding:8px 10px; border-radius:10px; font-size:.95rem; margin:6px 0}
    .pm--pending{border-left:4px solid var(--warn)} .pm--done{border-left:4px solid var(--ok)}
    .mobile-tabs{display:none; gap:8px; position:sticky; top:0; z-index:5; padding:8px 0}
    .mobile-tabs button{flex:1; padding:10px 12px; border-radius:999px; border:1px solid #2a3242; background:#0f1422; color:#cfd6e6; font-weight:700}
    .mobile-tabs button.active{background:var(--accent); color:#0b0e13; border-color:transparent}
    .mobile-section{display:block}
    @media (max-width: 820px){ .mobile-tabs{display:flex} .mobile-section{display:none} .mobile-section.active{display:block} }
    .flash{box-shadow:0 0 0 3px var(--accent) inset}
  </style>
</head>
<body>
  <div class="container">
    <header class="flex" style="justify-content:space-between; align-items:flex-start; gap:16px; margin-bottom:12px">
      <div>
        <h1>🏆 Liga Femenina – <span style="color:#ccff00">No puedo, tengo pádel</span></h1>
        <div class="small">Supabase + caché local. Cruces ida/vuelta, resultados y tabla.</div>
      </div>
      <div class="pill">🌐 Supabase • v11</div>
    </header>

    <nav class="mobile-tabs" id="mobileTabs">
      <button type="button" data-target="#sec-parejas">👥 Parejas</button>
      <button type="button" data-target="#sec-cuadros" class="active">🎾 Partidos</button>
      <button type="button" data-target="#sec-resumen">📋 Resumen</button>
      <button type="button" data-target="#sec-tabla">📊 Tabla</button>
    </nav>

    <section id="sec-parejas" class="grid mobile-section">
      <div class="card">
        <div class="hd"><strong>➕ Parejas / Jugadoras</strong><span class="small">Se guardan en Supabase (si configuraste la API), con orden.</span></div>
        <div class="bd">
          <div class="actions">
            <input id="teamName" placeholder="Ej: Jessi/Ck" style="max-width:260px" />
            <button id="addPair" class="primary">Agregar pareja</button>
            <button id="reloadAll" class="ghost">🔄 Recargar</button>
          </div>
          <div id="teamList" class="compact-list" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <section id="sec-cuadros" class="grid mobile-section">
      <div class="card">
        <div class="hd"><strong>📆 Cuadros (Ida/Vuelta)</strong>
          <div class="actions">
            <button id="regenFixture" class="primary">Regenerar</button>
            <label class="small">Vista:
              <select id="filterLeg" style="width:auto"><option value="ALL">Todo</option><option value="ida">Ida</option><option value="vuelta">Vuelta</option></select>
            </label>
            <label class="small">Jornada:
              <select id="filterRound" style="width:auto"><option value="ALL">Todas</option></select>
            </label>
          </div>
        </div>
        <div class="bd">
          <div class="small" style="margin-bottom:8px">Con <strong>7</strong> parejas hay <strong>21</strong> partidos por leg. Con 8 parejas, <strong>28</strong>.</div>
          <div id="fixtureInfo" class="small"></div>
          <div class="scroll" id="cards"></div>
        </div>
      </div>
    </section>

    <section id="sec-resumen" class="grid mobile-section">
      <div class="card" id="summaryCard">
        <div class="hd"><strong>📋 Resumen de Partidos (Ida/Vuelta)</strong>
          <div class="actions">
            <button id="toggleSummary" class="ghost">Colapsar</button>
            <label class="small">Vista:
              <select id="sumLeg" style="width:auto"><option value="ALL">Todo</option><option value="ida">Ida</option><option value="vuelta">Vuelta</option></select>
            </label>
            <label class="small">Jornada:
              <select id="sumRound" style="width:auto"><option value="ALL">Todas</option></select>
            </label>
            <label class="small"><input type="checkbox" id="sumShow"> Mostrar resultados</label>
          </div>
        </div>
        <div class="bd" id="summary"></div>
      </div>
    </section>

    <section id="sec-tabla" class="grid mobile-section">
      <div class="card">
        <div class="hd"><strong>📊 Tabla de posiciones</strong>
          <div class="actions"><button id="resetLocal" class="danger">Reiniciar cache local</button></div>
        </div>
        <div class="bd">
          <div style="overflow:auto">
            <table id="standings"><thead><tr>
              <th>#</th><th>Pareja</th><th>PJ</th><th>PG</th><th>PP</th><th>Games +</th><th>Games −</th><th>Dif</th><th>Puntos</th>
            </tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="hd"><strong>🗓️ Partidos guardados</strong><span class="small">Se muestran desde Supabase o caché</span></div>
        <div class="bd" id="matches"></div>
      </div>
    </section>

    <footer class="flex" style="justify-content:space-between; gap:8px; flex-wrap:wrap; margin-top:6px">
      <div class="small">Reglas: Victoria = <strong>3 pts</strong> • Derrota en 3 sets = <strong>0.5 pt</strong> • WO = 6–0 / 6–0.</div>
      <div class="pill" id="connBadge">🔌 Local</div>
    </footer>
  </div>

  <script type="module">
  const SUPABASE_URL = 'https://dyaptlmncbbmruyduerv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5YXB0bG1uY2JibXJ1eWR1ZXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1Nzc0MjgsImV4cCI6MjA3NjE1MzQyOH0.5bSZuq8G1XW3LYoM92J5skRuUpnUQYbd_oKT3toTSlA';
  const LEAGUE_ID = 'lfnpd-2025';
  const ALLOW_PUBLIC_WRITE = true;

  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  const hasSB = SUPABASE_URL.startsWith('http') && SUPABASE_ANON_KEY.length > 20;
  const supabase = hasSB ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
  const $ = (s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const LS_KEY = 'liga-padel-cache-v11';
  let state = loadLocal() || { teams: [], matches: [], fixtures:{ida:[],vuelta:[]}, dates:{}, showSummaryResults:false };
  const DEFAULT_TEAMS = ['Jessi/Ck','Vanessa/Auri','Patty/Vero','Valen/Sele','Enyor/Stef','Nathaly/Cristina','Nativid/Olga'];
  $('#connBadge').textContent = hasSB ? '🌐 Supabase' : '🔌 Local';
  initTabs();
  await reloadAll();
  bindUI();

  function saveLocal(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch{} }
  function loadLocal(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)); }catch{ return null; } }
  function uid(){ return Math.random().toString(36).slice(2,9); }
  function n(v){ const x = Number(v); return Number.isFinite(x)? x : 0; }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]||ch)); }
  function teamName(id){ const t = state.teams.find(t=>t.id===id); return t? t.name : '¿?'; }
  function toDateInputValue(v){ if(!v) return ''; const d=new Date(v); if(!isNaN(d)) return d.toISOString().slice(0,10); if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v; return ''; }
  function indexOfTeam(id){ return state.teams.findIndex(t=>t.id===id); }
  function orderPair(a,b){ const ia=indexOfTeam(a), ib=indexOfTeam(b); return (ia<=ib)? [a,b] : [b,a]; }
  function pairRank(a,b){ const [x,y]=orderPair(a,b); return [indexOfTeam(x), indexOfTeam(y)]; }
  function comparePairs(p1a,p1b,p2a,p2b){ const r1=pairRank(p1a,p1b), r2=pairRank(p2a,p2b); if(r1[0]!==r2[0]) return r1[0]-r2[0]; return r1[1]-r2[1]; }

  function buildRoundRobin(ids){
    const arr = ids.slice(); if(arr.length%2===1) arr.push('BYE'); const n = arr.length; const rounds=[];
    for(let r=0; r<n-1; r++){ const round=[]; for(let i=0;i<n/2;i++){ const a=arr[i], b=arr[n-1-i]; if(a!=='BYE' && b!=='BYE') round.push([a,b]); }
      rounds.push(round); arr.splice(1,0,arr.pop()); }
    return rounds;
  }

  async function reloadAll(){
    if(supabase){
      const { data: teams } = await supabase.from('teams').select('*').eq('league_id', LEAGUE_ID).order('position');
      if(!teams || teams.length===0){
        if(ALLOW_PUBLIC_WRITE){
          const seed = DEFAULT_TEAMS.map((name, i)=>({ name, position:i, league_id:LEAGUE_ID }));
          await supabase.from('teams').insert(seed);
          const { data: t2 } = await supabase.from('teams').select('*').eq('league_id', LEAGUE_ID).order('position');
          state.teams = (t2||[]).map(t=>({ id:t.id, name:t.name, position:t.position }));
        }else{
          state.teams = DEFAULT_TEAMS.map((name,i)=>({ id: uid(), name, position:i }));
        }
      }else{
        state.teams = teams.map(t=>({ id:t.id, name:t.name, position:t.position }));
      }
      const { data: matches } = await supabase.from('matches').select('*').eq('league_id', LEAGUE_ID);
      state.matches = (matches||[]).map(m=>({ id:m.id, uniq:m.uniq, A:m.team_a, B:m.team_b, leg:m.leg, round:m.round, sets:m.sets||[], wo:!!m.wo, ptsA:Number(m.pts_a||0), ptsB:Number(m.pts_b||0), date:m.date||'' }));
    }else{
      if(state.teams.length===0){ state.teams = DEFAULT_TEAMS.map((name,i)=>({ id: uid(), name, position:i })); saveLocal(); }
    }
    const ids = state.teams.map(t=>t.id);
    state.fixtures = { ida: buildRoundRobin(ids), vuelta: [] };
    state.fixtures.vuelta = state.fixtures.ida.map(r=> r.map(p=>[p[1],p[0]]));
    populateFilterRounds(); populateSummaryRounds();
    renderTeams(); renderCards(); renderSummary(); renderMatches(); renderStandings();
  }

  function bindUI(){
    $('#addPair').addEventListener('click', onAddTeam);
    $('#reloadAll').addEventListener('click', reloadAll);
    $('#regenFixture').addEventListener('click', ()=>{ const ids = state.teams.map(t=>t.id); state.fixtures.ida = buildRoundRobin(ids); state.fixtures.vuelta = state.fixtures.ida.map(r=> r.map(p=>[p[1],p[0]])); renderCards(); populateFilterRounds(); populateSummaryRounds(); renderSummary(); });
    $('#filterLeg').addEventListener('change', renderCards);
    $('#filterRound').addEventListener('change', renderCards);
    $('#sumLeg').addEventListener('change', renderSummary);
    $('#sumRound').addEventListener('change', renderSummary);
    const sumShow = $('#sumShow'); sumShow.checked = !!state.showSummaryResults; sumShow.addEventListener('change', ()=>{ state.showSummaryResults = sumShow.checked; saveLocal(); renderSummary(); });
    $('#resetLocal').addEventListener('click', ()=>{ if(confirm('¿Borrar caché local?')){ localStorage.removeItem(LS_KEY); location.reload(); } });

    const tabs = $$('#mobileTabs button'); const sections = ['#sec-parejas','#sec-cuadros','#sec-resumen','#sec-tabla'].map(s=>$(s));
    function isMobile(){ return window.matchMedia('(max-width:820px)').matches; }
    function activate(sel){ tabs.forEach(b=>b.classList.toggle('active', b.dataset.target===sel)); sections.forEach(sec=> sec && (sec.classList.toggle('active','#'+sec.id===sel), sec.classList.add('mobile-section'))); }
    tabs.forEach(btn=> btn.addEventListener('click', ()=> activate(btn.dataset.target)));
    window.addEventListener('resize', ()=>{ if(!isMobile()){ sections.forEach(sec=>sec && sec.classList.add('active')); } });
    if(isMobile()) activate('#sec-cuadros'); else sections.forEach(sec=>sec && sec.classList.add('active'));
  }

  async function onAddTeam(){
    const name = $('#teamName').value.trim(); if(!name){ alert('Nombre vacío'); return; }
    if(state.teams.some(t=>t.name.toLowerCase()===name.toLowerCase())){ alert('Ya existe'); return; }
    const position = state.teams.length;
    if(supabase){
      const { data, error } = await supabase.from('teams').insert({ name, position, league_id: LEAGUE_ID }).select('*').single();
      if(error){ alert('No se pudo guardar en Supabase'); console.warn(error); return; }
      state.teams.push({ id:data.id, name:data.name, position:data.position });
    }else{
      state.teams.push({ id: uid(), name, position });
      saveLocal();
    }
    $('#teamName').value='';
    await reloadAll();
  }

  function renderTeams(){
    const list = $('#teamList');
    const html = state.teams.map((t,i)=>`
      <div class="row" style="align-items:center">
        <div class="col-10">
          <strong>${escapeHtml(t.name)}</strong> <span class="small">· #${i+1}</span>
        </div>
        <div class="col-2 actions">
          <button class="ghost" onclick="moveTeam(${i},-1)">↑</button>
          <button class="ghost" onclick="moveTeam(${i},1)">↓</button>
          <button class="danger" onclick="removeTeam('${t.id}')">Eliminar</button>
        </div>
      </div>`).join('');
    list.innerHTML = html || '<span class="small">Sin parejas</span>';
  }

  window.moveTeam = async (i,dir)=>{
    const j=i+dir; if(j<0 || j>=state.teams.length) return;
    const x=state.teams.splice(i,1)[0]; state.teams.splice(j,0,x);
    state.teams.forEach((t,idx)=> t.position = idx);
    if(supabase){
      await supabase.from('teams').upsert(state.teams.map(t=>({ id:t.id, position:t.position, league_id: LEAGUE_ID })));
    } else saveLocal();
    await reloadAll();
  };

  window.removeTeam = async (id)=>{
    if(!confirm('¿Eliminar esta pareja?')) return;
    if(supabase){
      await supabase.from('matches').delete().eq('league_id', LEAGUE_ID).or('team_a.eq.'+id+',team_b.eq.'+id);
      await supabase.from('teams').delete().eq('id', id);
    }else{
      state.teams = state.teams.filter(t=>t.id!==id);
      state.matches = state.matches.filter(m=>m.A!==id && m.B!==id);
      saveLocal();
    }
    await reloadAll();
  };

  function populateFilterRounds(){
    const rounds = (state.fixtures.ida||[]).length;
    const sel = $('#filterRound'); const cur = sel.value;
    sel.innerHTML = '<option value="ALL">Todas</option>'+ Array.from({length:rounds},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('');
    if(Array.from(sel.options).some(o=>o.value===cur)) sel.value = cur;
  }
  function populateSummaryRounds(){
    const rounds = (state.fixtures.ida||[]).length;
    const sel = $('#sumRound'); const cur = sel.value;
    sel.innerHTML = '<option value="ALL">Todas</option>'+ Array.from({length:rounds},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('');
    if(Array.from(sel.options).some(o=>o.value===cur)) sel.value = cur;
  }

  function makeSetGroup(uniq, i, sets){
    const vA = (sets[i] && sets[i][0]) || ''; const vB = (sets[i] && sets[i][1]) || '';
    return `<div class="flex" style="gap:6px; align-items:center"><span class="small">S${i+1}</span>
      <input class="num" id="${uniq}_s${i+1}a" type="number" min="0" placeholder="A" value="${vA}">
      <input class="num" id="${uniq}_s${i+1}b" type="number" min="0" placeholder="B" value="${vB}"></div>`;
  }

  function makeCard(a,b,leg,ri,idx){
    const ia=indexOfTeam(a), ib=indexOfTeam(b); const aId= (ia<=ib)? a:b, bId=(ia<=ib)? b:a;
    const A = escapeHtml(teamName(aId)); const B = escapeHtml(teamName(bId));
    const uniq = [aId,bId].slice().sort().join('__')+'_'+leg+'_'+ri+'_'+idx;
    const existing = state.matches.find(m=>m.uniq===uniq);
    const sets = (existing && existing.sets) || [];
    const wo = (existing && existing.wo) ? 'checked' : '';
    const dateVal = toDateInputValue((existing && existing.date));
    return `<div class="card" style="margin-bottom:10px">
      <div class="bd">
        <div class="match-head">
          <div class="mh-date small">📅 <input id="${uniq}_date" type="date" value="${dateVal||''}"></div>
          <div class="mh-title"><span class="lab">A:</span> <strong>${A}</strong> <span>|</span> <span class="lab">B:</span> <strong>${B}</strong></div>
        </div>
        <div class="actions" style="margin-top:8px; flex-wrap:wrap">
          ${makeSetGroup(uniq,0,sets)}  ${makeSetGroup(uniq,1,sets)}  ${makeSetGroup(uniq,2,sets)}
          <label class="small"><input id="${uniq}_wo" type="checkbox" ${wo}> WO</label>
          <button class="ok" onclick="saveCard('${aId}','${bId}','${leg}',${ri},${idx})">${existing?'Actualizar':'Guardar'}</button>
        </div>
      </div>
    </div>`;
  }

  function jornadaBlock(title, games, leg, ri){
    const gamesSorted = games.slice().sort((g1,g2)=> comparePairs(g1[0],g1[1],g2[0],g2[1]));
    const inner = gamesSorted.map((g,idx)=> makeCard(g[0],g[1],leg,ri,idx)).join('');
    return `<details class="round" ${ri===0?'open':''}><summary><h3 class="small" style="display:inline">${title}</h3></summary>${inner || '<div class="small">Sin partidos</div>'}</details>`;
  }

  function col(title, rounds, leg){
    const roundFilter = $('#filterRound').value || 'ALL';
    let mapped = rounds.map((games,ri)=>({ri,games}));
    if(roundFilter!=='ALL'){ const rIndex = Number(roundFilter)-1; mapped = mapped.filter(x=>x.ri===rIndex); }
    const blocks = mapped.map(x=> jornadaBlock('Jornada '+(x.ri+1), x.games, leg, x.ri)).join('');
    return `<div style="min-width:360px; max-width:100%; padding-right:10px"><h2 style="margin:6px 0 10px">${title}</h2>${blocks || '<div class="small">Sin partidos</div>'}</div>`;
  }

  function renderCards(){
    const root = $('#cards'); const info = $('#fixtureInfo');
    const ida = state.fixtures.ida||[]; const vuelta = state.fixtures.vuelta||[];
    const nTeams = state.teams.length; const perLeg = nTeams*(nTeams-1)/2;
    if(info) info.textContent = `Ida: ${ida.reduce((a,r)=>a+r.length,0)} / ${perLeg} · Vuelta: ${vuelta.reduce((a,r)=>a+r.length,0)} / ${perLeg}`;
    const legFilter = $('#filterLeg').value || 'ALL';
    const showIda = (legFilter==='ALL' || legFilter==='ida'); const showVuelta = (legFilter==='ALL' || legFilter==='vuelta');
    const html = `<div style="display:flex; gap:18px; align-items:flex-start"> ${(showIda? col('IDA', ida, 'ida') : '')} ${(showVuelta? col('VUELTA', vuelta, 'vuelta') : '')} </div>`;
    root.innerHTML = html;

    $$('#cards input[type="date"]').forEach(inp=> inp.addEventListener('change', async function(){
      const uniq = this.id.replace('_date','');
      const rec = state.matches.find(x=>x.uniq===uniq); if(rec){ rec.date = this.value || null; await upsertMatch(rec); renderMatches(); renderSummary(); }
    }));
  }

  window.saveCard = async (a,b,leg,ri,idx)=>{
    const pair = [a,b].slice().sort().join('__'); const uniq = `${pair}_${leg}_${ri}_${idx}`;
    const get = id => document.getElementById(id);
    const wo = get(uniq+'_wo').checked;
    const date = (get(uniq+'_date') && get(uniq+'_date').value) || null;
    let sets=[];
    if(wo){ sets=[[6,0],[6,0]]; }
    else{
      const ids=[[uniq+'_s1a',uniq+'_s1b'],[uniq+'_s2a',uniq+'_s2b'],[uniq+'_s3a',uniq+'_s3b']];
      const vals = ids.map(p=>[Number(get(p[0]).value)||0, Number(get(p[1]).value)||0]).filter(ab=>ab[0]>0 || ab[1]>0);
      if(vals.length<2){ alert('Carga al menos dos sets o marca WO'); return; }
      sets = vals;
    }
    const sw = sets.reduce((acc,ab)=>{ if(ab[0]>ab[1]) acc.a++; else if(ab[1]>ab[0]) acc.b++; return acc; }, {a:0,b:0});
    if(sw.a===sw.b && sets.length<3){ alert('Empate a sets, falta el 3er set'); return; }
    const winner = sw.a>sw.b? 'A':'B';
    let ptsA=0, ptsB=0; if(winner==='A'){ ptsA+=3; if(sets.length===3) ptsB+=0.5; } else { ptsB+=3; if(sets.length===3) ptsA+=0.5; }

    let rec = state.matches.find(m=>m.uniq===uniq);
    const base = { uniq, A:a, B:b, leg, round:ri+1, sets, wo, ptsA, ptsB, date };
    if(rec){ Object.assign(rec, base); } else { rec = { id: uid(), ...base }; state.matches.push(rec); }
    await upsertMatch(rec);
    renderMatches(); renderStandings(); renderSummary();
    try{ const det = document.getElementById(uniq+'_date').closest('details.round'); if(det) det.open=false; const sum=$('#summary'); sum&&sum.scrollIntoView({behavior:'smooth'}); }catch{}
  };

  async function upsertMatch(rec){
    if(supabase){
      const payload = { league_id: LEAGUE_ID, uniq: rec.uniq, leg: rec.leg, round: rec.round,
        team_a: rec.A, team_b: rec.B, date: rec.date, wo: rec.wo, sets: rec.sets, pts_a: rec.ptsA, pts_b: rec.ptsB };
      const { data, error } = await supabase.from('matches').upsert(payload).select('*').single();
      if(error){ console.warn(error); alert('No se pudo guardar en Supabase'); }
      else { rec.id = data.id; }
    } else saveLocal();
  }

  window.deleteMatch = async (id)=>{
    const rec = state.matches.find(m=>m.id===id || m.uniq===id);
    if(!rec) return;
    if(!confirm(`¿Eliminar R${rec.round} ${teamName(rec.A)} vs ${teamName(rec.B)}?`)) return;
    if(supabase){
      await supabase.from('matches').delete().eq('uniq', rec.uniq).eq('league_id', LEAGUE_ID);
    }
    state.matches = state.matches.filter(m=>m.uniq!==rec.uniq);
    saveLocal();
    renderMatches(); renderStandings(); renderSummary(); renderCards();
  };

  function renderMatches(){
    const root = $('#matches'); if(state.matches.length===0){ root.innerHTML = '<div class="small">Sin partidos</div>'; return; }
    const fmt = d=>{ if(!d) return ''; const dt=new Date(d); return isNaN(dt)? d : dt.toLocaleDateString(); };
    root.innerHTML = state.matches.slice().sort((a,b)=> (a.round||0)-(b.round||0) || (a.leg||'ida').localeCompare(b.leg||'ida')).map(m=>{
      const aN=escapeHtml(teamName(m.A)), bN=escapeHtml(teamName(m.B));
      const winA = m.ptsA>m.ptsB, winB = m.ptsB>m.ptsA;
      const aL = winA? '🏅 '+aN : aN; const bL = winB? '🏅 '+bN : bN;
      const setsTxt = (m.sets||[]).map(ab=> `${(ab[0]||0)}-${(ab[1]||0)}`).join(', ');
      const tag = m.wo? '<span class="pill">WO</span>' : '';
      const when = m.date? ` • <span class="small">${fmt(m.date)}</span>` : '';
      return `<div class="flex" style="justify-content:space-between; padding:8px 0; border-bottom:1px dashed #263044">
        <div><div><span class="pill">R${m.round}</span> <strong>${aL}</strong> vs <strong>${bL}</strong>${when}</div><div class="small">Sets: ${setsTxt} ${tag}</div></div>
        <div class="actions"><button class="danger" onclick="deleteMatch('${m.id||m.uniq}')">Eliminar</button></div>
      </div>`;
    }).join('');
  }

  function renderStandings(){
    const stats = {}; state.teams.forEach(t=> stats[t.id]={ id:t.id, name:t.name, PJ:0, PG:0, PP:0, GW:0, GL:0, PTS:0 });
    state.matches.forEach(m=>{
      const {A,B,sets,ptsA,ptsB} = m; if(!stats[A]||!stats[B]) return;
      stats[A].PJ++; stats[B].PJ++; let sA=0,sB=0, gA=0,gB=0;
      sets.forEach(ab=>{ const a=(ab && ab[0])||0; const b=(ab && ab[1])||0; if(a>b) sA++; else if(b>a) sB++; gA+=a; gB+=b; });
      stats[A].GW+=gA; stats[A].GL+=gB; stats[B].GW+=gB; stats[B].GL+=gA;
      if(sA>sB){ stats[A].PG++; stats[B].PP++; } else { stats[B].PG++; stats[A].PP++; }
      stats[A].PTS+=ptsA; stats[B].PTS+=ptsB;
    });
    const arr = state.teams.map(t=>stats[t.id]).filter(Boolean);
    $('#standings tbody').innerHTML = arr.map((r,i)=>`<tr><td>${i+1}</td><td>${escapeHtml(r.name)}</td><td>${r.PJ}</td><td>${r.PG}</td><td>${r.PP}</td><td>${r.GW}</td><td>${r.GL}</td><td>${r.GW-r.GL}</td><td><strong>${(Math.round(r.PTS*10)/10).toFixed(1).replace('.0','')}</strong></td></tr>`).join('')
      || `<tr><td colspan="9" class="small">Sin datos</td></tr>`;
  }

  function renderSummary(){
    const box = $('#summary');
    const legFilter = $('#sumLeg').value || 'ALL';
    const roundFilter = $('#sumRound').value || 'ALL';
    const showResults = $('#sumShow').checked;

    const legs=[];
    if(legFilter==='ALL' || legFilter==='ida') legs.push(['IDA', state.fixtures.ida, 'ida']);
    if(legFilter==='ALL' || legFilter==='vuelta') legs.push(['VUELTA', state.fixtures.vuelta, 'vuelta']);

    const makeBlock = (title, rounds, leg)=>{
      if(!rounds || !rounds.length) return '';
      const cards = rounds.map((games,i)=>{
        if(roundFilter!=='ALL' && i!==Number(roundFilter)-1) return '';
        const gamesSorted = games.slice().sort((g1,g2)=> comparePairs(g1[0],g1[1],g2[0],g2[1]));
        const items = gamesSorted.map((pair,idx)=>{
          const [a,b] = (indexOfTeam(pair[0])<=indexOfTeam(pair[1]))? [pair[0],pair[1]] : [pair[1],pair[0]];
          const uniq = [a,b].slice().sort().join('__')+'_'+leg+'_'+i+'_'+idx;
          const rec = state.matches.find(m=>m.uniq===uniq);
          const aN = escapeHtml(teamName(a)); const bN = escapeHtml(teamName(b));
          let labA = aN, labB = bN, chip='';
          if(rec && showResults){
            const winA = rec.ptsA>rec.ptsB, winB = rec.ptsB>rec.ptsA;
            if(winA) labA = '<span class="win">🏅 <strong>'+labA+'</strong></span>';
            if(winB) labB = '<span class="win">🏅 <strong>'+labB+'</strong></span>';
            const setsTxt = (rec.sets||[]).map(ab=> `${(ab[0]||0)}-${(ab[1]||0)}`).join(', ');
            if(setsTxt) chip = '<div class="small">🧾 <span class="pill">'+setsTxt+'</span></div>';
          }
          const dateVal = toDateInputValue((rec||{}).date);
          return `<div class="pill-match ${rec ? 'pm--done' : 'pm--pending'}" id="pill_${uniq}">
              <div class="small" style="display:flex; justify-content:flex-end">📅 <input type="date" id="sum_${uniq}" value="${dateVal||''}" style="width:auto"></div>
              <div class="pm-title">🎾 <span class="lab">A:</span> <strong>${labA}</strong> <span>|</span> <span class="lab">B:</span> <strong>${labB}</strong></div>
              ${chip}
              <div class="actions" style="justify-content:center; margin-top:6px"><button class="ghost" onclick="openMatch('${uniq}')">Ir al partido</button></div>
            </div>`;
        }).join('');
        return `<div class="sum-card sum-card--${leg}"><h4><span>${title}</span> · Jornada ${i+1}</h4>${items || '<span class="small">(sin partidos)</span>'}</div>`;
      }).join('');
      return cards;
    };

    box.innerHTML = `<div class="sum-legend small">
      <span class="legend-dot" style="background:#2b6cb0"></span> Ida
      <span class="legend-dot" style="background:#2b7a0b; margin-left:10px"></span> Vuelta
      <span class="legend-dot" style="background:#ffc107; margin-left:10px"></span> Pendiente
      <span class="legend-dot" style="background:#32d296; margin-left:10px"></span> Cargado
    </div>
    <div class="sum-grid">${legs.map(([t,r,k])=>makeBlock(t,r,k)).join('')}</div>`;

    $$('#summary input[type="date"]').forEach(inp=>{
      inp.addEventListener('change', async function(){
        const uniq = this.id.replace('sum_','');
        const rec = state.matches.find(x=>x.uniq===uniq); if(rec){ rec.date = this.value || null; await upsertMatch(rec); renderCards(); renderMatches(); }
      });
    });
  }

  window.openMatch = function(uniq){
    try{ const el = document.getElementById(uniq+'_date'); if(!el){ alert('No encontré la card del partido.'); return; } const det = el.closest('details.round'); if(det) det.open = true; el.scrollIntoView({behavior:'smooth', block:'center'}); el.classList.add('flash'); setTimeout(()=> el.classList.remove('flash'), 1200); }catch(e){ console.error(e); }
  };

  function initTabs(){
    const tabs = $$('#mobileTabs button'); const sections = ['#sec-parejas','#sec-cuadros','#sec-resumen','#sec-tabla'].map(s=>$(s));
    function isMobile(){ return window.matchMedia('(max-width:820px)').matches; }
    function activate(sel){ tabs.forEach(b=>b.classList.toggle('active', b.dataset.target===sel)); sections.forEach(sec=>sec && (sec.classList.toggle('active','#'+sec.id===sel), sec.classList.add('mobile-section'))); }
    tabs.forEach(btn=> btn.addEventListener('click', ()=> activate(btn.dataset.target)));
    window.addEventListener('resize', ()=>{ if(!isMobile()){ sections.forEach(sec=>sec && sec.classList.add('active')); } });
    if(isMobile()) activate('#sec-cuadros'); else sections.forEach(sec=>sec && sec.classList.add('active'));
  }
  </script>
</body>
</html>
