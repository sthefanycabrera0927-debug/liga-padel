<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Liga Femenina ‚Äì No puedo, tengo p√°del</title>
<style>
:root{
 --bg:#f7f9fb; --panel:#ffffff; --text:#0f1220; --muted:#5d667b; --border:#e6e9ef;
 --accent:#2dd24c; --accent-ink:#0a1b10; --danger:#ff5470; --ok:#22c55e; --chip:#f0f3f8; --line:#dfe4ec;
}
*{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;background:var(--bg);color:var(--text)}
h1,h2{margin:.2rem 0} h1{font-size:clamp(1.4rem,2.3vw,2.2rem)}
.container{max-width:1100px;margin:0 auto;padding:20px}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 20px rgba(16,24,40,.04)}
.card .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
.card .bd{padding:14px 16px}
.card.togglable .hd{cursor:pointer}
.card.is-collapsed .bd{display:none}

.pill{display:inline-flex;gap:.5rem;align-items:center;padding:.35rem .7rem;border-radius:999px;background:var(--chip);color:#3b4252;font-size:.85rem;border:1px solid var(--border)}
input,select,button{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#111;outline:none}
input[type='text'],input[type='number'],select,button{width:100%}
.actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.primary{background:var(--accent);color:var(--accent-ink);border:none;font-weight:700}
.ghost{background:#fff}
.danger{background:var(--danger);color:#fff;border:none}
.ok{background:var(--ok);color:#0c1b10;border:none}
.small{font-size:.85rem;color:var(--muted)}

/* Avatar */
.avatar{display:inline-flex;align-items:center;gap:8px}
.avatar img{width:28px;height:28px;border-radius:999px;object-fit:cover;border:1px solid var(--border)}
.avatar .init{width:28px;height:28px;border-radius:999px;display:grid;place-items:center;background:#eef2f7;border:1px solid var(--border);font-size:.8rem;font-weight:700;color:#334}
.name{white-space:normal;line-height:1.2}

/* Cruces (colapsable) */
details.cruces{border:1px dashed var(--border);border-radius:12px;padding:8px 10px;background:#fff}
details.cruces>summary{cursor:pointer;list-style:none;font-weight:700}
details.cruces>summary::-webkit-details-marker{display:none}

/* Cruces ‚Äì tarjetas bonitas en grilla */
.fixture-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
@media (max-width:1024px){.fixture-grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:560px){.fixture-grid{grid-template-columns:1fr}}
.fx-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.04)}
.fx-card b{display:block;margin:6px 0}

/* Juegos (cargar resultados) */
.lanes{display:grid;gap:12px;grid-template-columns:repeat(2, minmax(0,1fr))}
@media (max-width:720px){.lanes{grid-template-columns:1fr}}
.match{position:relative;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.03)}
.mh{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:6px}
.mh .date{display:flex;gap:8px;align-items:center}
.mh input[type="date"]{width:auto;min-width:140px}
.row-score{display:grid;grid-template-columns:minmax(140px,1fr) 56px 56px 56px;gap:8px;align-items:center;margin-top:6px}
.setBox{width:56px;height:48px;border:1px solid var(--border);border-radius:10px;font-size:22px;text-align:center;font-weight:700}
@media (max-width:640px){.row-score{grid-template-columns:minmax(120px,1fr) 52px 52px 52px}.setBox{width:52px;height:46px;font-size:20px}}

/* Tabla scroll m√≥vil */
.table-wrap{width:100%;overflow:auto}
table{width:100%;border-collapse:collapse;min-width:720px}
th,td{padding:8px 6px;border-bottom:1px solid var(--border);text-align:left}
th{position:sticky;top:0;background:var(--panel)}

/* Toast simple */
.toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,.2);opacity:.95;z-index:999}
</style>
</head>
<body>
<div class="container">
  <header class="flex" style="justify-content:space-between;align-items:flex-start;gap:16px;margin-bottom:12px">
    <div>
      <h1>üèÜ Liga Femenina ‚Äì <span style="color:#10b981">No puedo, tengo p√°del</span></h1>
      <div class="small">Supabase (sin cach√©). Cruces, juegos y tabla.</div>
    </div>
    <div class="actions">
      <button id="btnMine" class="ghost" style="display:none">üëÄ Ver solo mis partidos</button>
      <div class="pill" id="connBadge">üåê Supabase</div>
    </div>
  </header>

  <nav class="actions" style="margin-bottom:6px">
    <label class="small">Pareja:
      <select id="filterTeam" style="width:auto;min-width:180px"><option value="ALL">Todas</option></select>
    </label>
  </nav>

  <!-- PAREJAS -->
  <section class="grid">
    <div class="card togglable is-collapsed" id="pairsCard">
      <div class="hd"><strong>üë• Parejas / Jugadoras</strong></div>
      <div class="bd"><div id="teamList"></div></div>
    </div>
  </section>

  <!-- CRUCES (bonitos) -->
  <section class="grid">
    <div class="card togglable is-collapsed" id="crucesCard">
      <div class="hd">
        <strong>üéæ Cruces</strong>
        <div class="small" id="fixtureInfo"></div>
      </div>
      <div class="bd">
        <details class="cruces" id="block-ida"><summary>IDA</summary>
          <div class="fixture-grid" id="fixture-ida"></div>
        </details>
        <details class="cruces" id="block-vuelta" style="margin-top:12px"><summary>VUELTA</summary>
          <div class="fixture-grid" id="fixture-vuelta"></div>
        </details>
      </div>
    </div>
  </section>

  <!-- JUEGOS (cargar resultados) -->
  <section class="grid">
    <div class="card togglable is-collapsed" id="gamesCard">
      <div class="hd"><strong>üìù Juegos (cargar resultados)</strong></div>
      <div class="bd">
        <details id="games-ida"><summary><b>IDA</b></summary><div class="lanes" id="lanes-ida"></div></details><br>
        <details id="games-vuelta"><summary><b>VUELTA</b></summary><div class="lanes" id="lanes-vuelta"></div></details>
      </div>
    </div>
  </section>

  <!-- TABLA (siempre visible) -->
  <section class="grid">
    <div class="card">
      <div class="hd">
        <strong>üìä Tabla de posiciones</strong>
      </div>
      <div class="bd">
        <div class="table-wrap">
          <table id="standings"><thead><tr>
            <th>#</th><th>Pareja</th><th>PJ</th><th>PG</th><th>PP</th><th>Games +</th><th>Games ‚àí</th><th>Dif</th><th>Puntos</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </section>

  <footer class="flex" style="justify-content:space-between;gap:8px;flex-wrap:wrap;margin-top:6px">
    <div class="small">Reglas: Victoria = <strong>3 pts</strong> ‚Ä¢ Derrota = <strong>0 pts</strong>.</div>
    <a class="pill" href="index.html">üîê Salir / Login</a>
  </footer>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script type="module">
/* ========= SUPABASE ========= */
const SUPABASE_URL = 'https://dyaptlmncbbmruyduerv.supabase.co';
const SUPABASE_ANON_KEY =
 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5YXB0bG1uY2JibXJ1eWR1ZXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1Nzc0MjgsImV4cCI6MjA3NjE1MzQyOH0.5bSZuq8G1XW3LYoM92J5skRuUpnUQYbd_oKT3toTSlA';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const LEAGUE_ID = 'lfnpd-2025';

const $ = (s,r=document)=>r.querySelector(s);
let teams = [];
let matches = [];
let fixture = { ida: [], vuelta: [] };
let myTeamId = null; // para "mis partidos"

init();

async function init(){
  await detectMe();
  await loadAll();
  bindUI();
  subscribeRealtime();
  try{ await Notification.requestPermission().catch(()=>{}); }catch{}
}

/* ====== sesi√≥n / perfil ====== */
async function detectMe(){
  const { data:{ session } } = await sb.auth.getSession();
  if(!session){ return; }
  // buscar team_id en profiles (si existe)
  const { data: prof } = await sb.from('profiles').select('team_id').eq('user_id', session.user.id).maybeSingle();
  if(prof?.team_id){ myTeamId = prof.team_id; $('#btnMine').style.display='inline-flex'; }
}

/* ====== Realtime Notifier ====== */
function subscribeRealtime(){
  const ch = sb.channel('matches_live')
    .on('postgres_changes',{ event: '*', schema: 'public', table: 'matches', filter:`league_id=eq.${LEAGUE_ID}` },
      payload => {
        const m = payload.new || payload.old;
        showToast('Resultado actualizado: ' + (m?.uniq || 'match'));
        if(Notification.permission==='granted'){
          try{ new Notification('Liga Femenina', { body:'Se carg√≥/actualiz√≥ un resultado.' }); }catch{}
        }
        loadAll();
      })
    .subscribe();
}

/* ====== LOAD ====== */
async function loadAll(){
  try{
    const { data: t, error: te } = await sb
      .from('teams').select('id,name,position,photo_url').eq('league_id', LEAGUE_ID).order('position');
    if(te) throw te;
    teams = (t||[]).map(x=>({ id:x.id, name:x.name, position:x.position, photo:x.photo_url||'' }));

    const { data: m, error: me } = await sb
      .from('matches').select('*').eq('league_id', LEAGUE_ID);
    if(me) throw me;
    matches = (m||[]).map(x=>({
      id:x.id, uniq:x.uniq, leg:x.leg, round:x.round,
      team_a:x.team_a, team_b:x.team_b,
      sets: Array.isArray(x.sets)? x.sets : [],
      pts_a: Number(x.pts_a||0), pts_b: Number(x.pts_b||0),
      date: x.date||null
    }));

    buildFixture();
    renderTeams();
    populateTeamFilter();
    renderFixture();
    renderGames();
    renderStandings();
  }catch(e){
    console.error('Error cargando Supabase:', e);
    alert('No se pudieron cargar datos de Supabase. Revisar credenciales/RLS.');
  }
}

/* ====== FIXTURE (Round Robin) ====== */
function buildFixture(){
  const ids = teams.map(t=>t.id);
  const arr = ids.slice();
  if(arr.length%2===1) arr.push('BYE');
  const n = arr.length;
  const rounds=[];
  for(let r=0;r<n-1;r++){
    const round=[];
    for(let i=0;i<n/2;i++){
      const a=arr[i], b=arr[n-1-i];
      if(a!=='BYE' && b!=='BYE') round.push([a,b]);
    }
    rounds.push(round);
    arr.splice(1,0,arr.pop());
  }
  fixture.ida = rounds;
  fixture.vuelta = rounds.map(rd=> rd.map(([a,b])=>[b,a]));
}

/* ====== UI BIND ====== */
function bindUI(){
  $('#pairsCard .hd').addEventListener('click', ()=> $('#pairsCard').classList.toggle('is-collapsed'));
  $('#crucesCard .hd').addEventListener('click', ()=> $('#crucesCard').classList.toggle('is-collapsed'));
  $('#gamesCard .hd').addEventListener('click', ()=> $('#gamesCard').classList.toggle('is-collapsed'));
  $('#filterTeam').addEventListener('change', ()=>{ renderGames(); });
  $('#btnMine').addEventListener('click', ()=>{
    if(!myTeamId) return;
    $('#filterTeam').value = myTeamId;
    renderGames();
  });
}

/* ====== TEAMS ====== */
function renderTeams(){
  $('#teamList').innerHTML = teams.map((t,i)=>`
    <div class="row">
      <div class="avatar" style="flex:1 1 auto">
        ${t.photo ? `<img src="${escape(t.photo)}" alt="">` : `<span class="init">${inits(t.name)}</span>`}
        <span class="name"><strong>${escape(t.name)}</strong> <span class="small">¬∑ #${i+1}</span></span>
      </div>
    </div>`).join('') || '<span class="small">Sin parejas</span>';
}

function populateTeamFilter(){
  $('#filterTeam').innerHTML = '<option value="ALL">Todas</option>' +
    teams.map(t=>`<option value="${t.id}">${escape(t.name)}</option>`).join('');
  if(myTeamId){ $('#btnMine').style.display='inline-flex'; }
}

/* ====== CRUCES (bonitos) ====== */
function renderFixture(){
  const ida = fixture.ida.flat();
  const vuelta = fixture.vuelta.flat();
  const nTeams = teams.length;
  const perLeg = nTeams*(nTeams-1)/2;
  $('#fixtureInfo').textContent = `Parejas: ${nTeams} ¬∑ Partidos por fase: ${perLeg}`;
  $('#fixture-ida').innerHTML = ida.map(([a,b])=> fxCard(a,b)).join('') || '<div class="small">(sin cruces)</div>';
  $('#fixture-vuelta').innerHTML = vuelta.map(([a,b])=> fxCard(a,b)).join('') || '<div class="small">(sin cruces)</div>';
}
function fxCard(a,b){
  const A = team(a), B = team(b);
  const Av = A.photo ? `<img src="${escape(A.photo)}" alt="">` : `<span class="init">${inits(A.name)}</span>`;
  const Bv = B.photo ? `<img src="${escape(B.photo)}" alt="">` : `<span class="init">${inits(B.name)}</span>`;
  return `<div class="fx-card">
    <div class="avatar" style="justify-content:center">${Av}<span class="name">${escape(A.name)}</span></div>
    <b>vs</b>
    <div class="avatar" style="justify-content:center">${Bv}<span class="name">${escape(B.name)}</span></div>
  </div>`;
}

/* ====== JUEGOS ====== */
function renderGames(){
  renderLeg('#lanes-ida', fixture.ida, 'ida');
  renderLeg('#lanes-vuelta', fixture.vuelta, 'vuelta');
}

function renderLeg(container, rounds, leg){
  const root = document.querySelector(container);
  const filt = $('#filterTeam').value || 'ALL';
  const list = rounds.map((games,ri)=> games.map((g,idx)=>({ri,idx,g}))).flat();
  const filtered = (filt==='ALL') ? list : list.filter(({g:[x,y]})=> x===filt || y===filt);

  root.innerHTML = filtered.map(({ri,idx,g:[a,b]})=> matchCard(a,b,leg,ri,idx)).join('') || '<div class="small">(sin partidos)</div>';

  // Auto-avance/foco por set: A1‚ÜíB1‚ÜíA2‚ÜíB2‚ÜíA3‚ÜíB3
  bindAutoAdvance(root);
}

function matchCard(a,b,leg,ri,idx){
  // IDs ordenados para uniq estable
  const ia = teams.findIndex(t=>t.id===a);
  const ib = teams.findIndex(t=>t.id===b);
  const aId = (ia<=ib)? a : b;
  const bId = (ia<=ib)? b : a;
  const A = team(aId), B = team(bId);
  const uniq = `${[aId,bId].slice().sort().join('__')}_${leg}_${ri}_${idx}`;

  const rec = matches.find(m=>m.uniq===uniq);
  const getVal = (s, p) => (rec && rec.sets && rec.sets[s] ? (rec.sets[s][p] ?? '') : '');
  const dateVal = rec?.date ? toDate(rec.date) : '';

  const avatar = t => t.photo ? `<img src="${escape(t.photo)}" alt="">` : `<span class="init">${inits(t.name)}</span>`;
  const input = (s, side) => {
    const p = side === 'a' ? 0 : 1;
    const id = `${uniq}_s${s+1}${side}`;
    return `<input class="setBox" id="${id}" type="number" min="0" inputmode="numeric" value="${getVal(s,p)}">`;
  };

  return `<div class="match">
    <div class="mh">
      <div class="avatar small"><span>${avatar(A)}</span><b>${escape(A.name)}</b>&nbsp;vs&nbsp;<span>${avatar(B)}</span><b>${escape(B.name)}</b></div>
      <div class="date"><span class="small">üìÖ</span><input id="${uniq}_date" type="date" value="${dateVal}"></div>
    </div>
    <div class="row-score">
      <span class="name">${escape(A.name)}</span>
      ${input(0,'a')}
      ${input(1,'a')}
      ${input(2,'a')}
    </div>
    <div class="row-score">
      <span class="name">${escape(B.name)}</span>
      ${input(0,'b')}
      ${input(1,'b')}
      ${input(2,'b')}
    </div>
    <div class="actions" style="margin-top:6px">
      <button class="primary" onclick="saveMatch('${uniq}','${aId}','${bId}','${leg}',${ri},${idx})">Guardar</button>
      <button class="ghost" onclick="deleteMatch('${uniq}')">Borrar</button>
    </div>
  </div>`;
}

function bindAutoAdvance(scope){
  const cards = scope.querySelectorAll('.match');
  cards.forEach(card=>{
    const first = card.querySelector('input.setBox'); if(!first) return;
    const uniq = first.id.split('_s')[0];
    const seqIds = [
      `${uniq}_s1a`, `${uniq}_s1b`,
      `${uniq}_s2a`, `${uniq}_s2b`,
      `${uniq}_s3a`, `${uniq}_s3b`,
    ];
    const seq = seqIds.map(id=> card.querySelector(`#${CSS.escape(id)}`)).filter(Boolean);
    seq[0]?.focus();
    seq.forEach((el,i)=>{
      el.addEventListener('input', ()=>{
        if(String(el.value).length>=1){
          const next = seq[i+1];
          if(next) next.focus();
        }
      });
      el.addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){ e.preventDefault(); const next = seq[i+1]; if(next) next.focus(); }
        if(e.key==='ArrowUp'){ const prev = seq[i-2] ?? seq[i-1]; if(prev){ e.preventDefault(); prev.focus(); } }
        if(e.key==='ArrowDown'){ const next = seq[i+1]; if(next){ e.preventDefault(); next.focus(); } }
        if(e.key==='ArrowLeft' && el.selectionStart===0){ const prev = seq[i-1]; if(prev){ e.preventDefault(); prev.focus(); } }
        if(e.key==='ArrowRight' && el.selectionStart===String(el.value).length){ const next = seq[i+1]; if(next){ e.preventDefault(); next.focus(); } }
      });
    });
  });
}

window.saveMatch = async(uniq,a,b,leg,ri,idx)=>{
  const gv = id => Number(document.getElementById(id)?.value || 0);
  const A1 = gv(`${uniq}_s1a`), B1 = gv(`${uniq}_s1b`);
  const A2 = gv(`${uniq}_s2a`), B2 = gv(`${uniq}_s2b`);
  const A3 = gv(`${uniq}_s3a`), B3 = gv(`${uniq}_s3b`);
  const dateVal = document.getElementById(`${uniq}_date`)?.value || null;

  const sets = [[A1,B1],[A2,B2],[A3,B3]].filter(([x,y])=> x>0 || y>0);
  if(sets.length<2){ alert('Carga al menos dos sets'); return; }
  let sa=0,sb=0; sets.forEach(([x,y])=>{ if(x>y) sa++; else if(y>x) sb++; });
  if(sa===sb && sets.length<3){ alert('Falta el 3er set'); return; }

  const pts_a = sa>sb ? 3 : 0;
  const pts_b = sb>sa ? 3 : 0;

  const payload = {
    league_id: LEAGUE_ID, uniq,
    leg, round: ri+1, team_a:a, team_b:b,
    sets, pts_a, pts_b, date: dateVal || null
  };
  const { error } = await sb.from('matches').upsert(payload).select('*').single();
  if(error){ console.error('upsert error', error); alert('No se pudo guardar el partido'); return; }
  showToast('‚úÖ Resultado guardado');
  await loadAll();
};

window.deleteMatch = async(uniq)=>{
  const { error } = await sb.from('matches').delete().eq('uniq', uniq).eq('league_id', LEAGUE_ID);
  if(error){ console.error('delete error', error); alert('No se pudo borrar'); return; }
  showToast('üóëÔ∏è Resultado borrado');
  await loadAll();
};

/* ====== STANDINGS ====== */
function renderStandings(){
  const stats={};
  teams.forEach(t=> stats[t.id]={ name:t.name,PJ:0,PG:0,PP:0,GW:0,GL:0,PTS:0 });

  matches.forEach(m=>{
    const A=m.team_a, B=m.team_b; if(!stats[A]||!stats[B]) return;
    let sA=0,sB=0,gA=0,gB=0;
    (m.sets||[]).forEach(([x,y])=>{ gA+=x; gB+=y; if(x>y) sA++; else if(y>x) sB++; });
    stats[A].PJ++; stats[B].PJ++;
    stats[A].GW+=gA; stats[A].GL+=gB; stats[B].GW+=gB; stats[B].GL+=gA;
    if(sA>sB){ stats[A].PG++; stats[B].PP++; } else { stats[B].PG++; stats[A].PP++; }
    stats[A].PTS += (m.pts_a||0); stats[B].PTS += (m.pts_b||0);
  });

  const arr = Object.entries(stats).map(([id,s])=>({id,...s}))
    .sort((x,y)=> (y.PTS-x.PTS) || (y.GW-x.GW));

  $('#standings tbody').innerHTML = arr.map((r,i)=>`
    <tr><td>${i+1}</td><td>${escape(r.name)}</td><td>${r.PJ}</td><td>${r.PG}</td><td>${r.PP}</td>
    <td>${r.GW}</td><td>${r.GL}</td><td>${r.GW-r.GL}</td><td><strong>${r.PTS}</strong></td></tr>
  `).join('') || `<tr><td colspan="9" class="small">Sin datos</td></tr>`;
}

/* ====== utils ====== */
function team(id){ return teams.find(t=>t.id===id) || {name:'¬ø?',photo:''}; }
function nm(id){ return team(id).name; }
function inits(name){ const p=name.split(/[\/\s]+/).filter(Boolean); return (p[0]?.[0]||'')+(p[1]?.[0]||''); }
function escape(s){ return String(s).replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]||ch)); }
function toDate(v){ try{ const d=new Date(v); if(!isNaN(d)) return d.toISOString().slice(0,10); if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v; }catch{} return ''; }

function showToast(msg){
  const t = $('#toast'); if(!t) return;
  t.textContent = msg; t.style.display='block';
  setTimeout(()=> t.style.display='none', 2200);
}
</script>
</body>
</html>
