<!-- build: 2025-10-16 18:10 -->

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Liga PRUEBA – No puedo, tengo pádel</title>
  <meta name="theme-color" content="#0f1115">
  <style>
    :root{
      --bg:#0f1115; --panel:#161a22; --panel-2:#1e2430; --text:#f7f7f7; --muted:#b9c0d0;
      --accent:#ccff00; --danger:#ff5470; --ok:#32d296; --warn:#ffc107;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:linear-gradient(180deg,#0b0e13 0%, #111521 100%); color:var(--text)}
    h1,h2{margin:.2rem 0}
    h1{font-size:clamp(1.4rem,2.3vw,2.2rem)}
    .container{max-width:1200px; margin:0 auto; padding:24px}
    .grid{display:grid; grid-template-columns: 1fr; gap:20px}
    .card{background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%); border:1px solid #232a38; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card .hd{display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid #222a36}
    .card .bd{padding:16px 18px}
    .pill{display:inline-flex; gap:.5rem; align-items:center; padding:.35rem .7rem; border-radius:999px; background:#1a202e; color:#b9c0d0; font-size:.85rem}
    input,select,button,textarea{padding:8px 10px; border-radius:10px; border:1px solid #2a3242; background:#131824; color:#f0f3fa; outline:none}
    input[type="text"], input[type="number"], select, button{width:100%}
    input::placeholder{color:#7c879c}
    label{font-size:.9rem; color:#c7cfdd}
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    button{cursor:pointer; font-weight:600}
    .primary{background:var(--accent); color:#0b0e13; border:none}
    .ghost{background:#121724}
    .danger{background:var(--danger); border:none}
    .ok{background:var(--ok); color:#08130e}
    .warn{background:var(--warn); color:#1a1200; border:none}
    table{width:100%; border-collapse:collapse}
    th,td{padding:8px 6px; border-bottom:1px solid #252c3a; text-align:left; vertical-align:middle}
    th{color:#cdd6e8; font-weight:700; font-size:.85rem; position:sticky; top:0; background:var(--panel)}
    td{color:#e9edf6; font-size:.9rem}
    tbody tr:hover{background:#151b28}
    .tag{padding:.2rem .5rem; border-radius:6px; font-size:.8rem; background:#202a3b; color:#b7c3d6}
    .flex{display:flex; gap:10px; align-items:center}
    .small{font-size:.8rem; color:#a8b2c6}
    .foot{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap}
    .scroll{overflow:auto; max-height:60vh}
    .nowrap{white-space:nowrap}
    .num{width:48px}
    .chk{width:auto}
    .row{display:grid; grid-template-columns:repeat(12, minmax(0,1fr)); gap:8px}
    .col-2{grid-column: span 2}
    .col-10{grid-column: span 10}
    .col-12{grid-column: span 12}
    .badge{background:#202a3b; padding:.2rem .5rem; border-radius:8px}
    .icon-btn{width:auto; padding:6px 10px; min-width:36px; text-align:center}
    .bd details{border:1px dashed #2a3242; border-radius:12px; padding:10px 12px}
    details>summary{cursor:pointer; list-style:none}
    details>summary::-webkit-details-marker{display:none}
    .compact-list .row{margin-bottom:4px}
    #teamName{flex:1}
    .round h3{margin:6px 0 8px; font-weight:600; color:#c7cfdd}
    .edit-input{width:100%; max-width:none; font-size:0.95rem}
    .match-head{display:flex; flex-direction:column; gap:8px}
    .mh-title{text-align:center; font-weight:600; display:inline-flex; gap:12px; align-items:center}
    .mh-title .lab{background:#202a3b; padding:.2rem .5rem; border-radius:8px; font-weight:700; opacity:.9}
    .mh-sep{opacity:.6}
    .mh-date{display:flex; justify-content:flex-end}
    .mh-date input{width:auto; min-width:130px}
    .sum-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:12px}
    .sum-card{border:1px solid #2a3242; border-radius:12px; padding:12px}
    .sum-card h4{margin:0 0 8px; font-size:0.95rem; color:#c7cfdd}
    .sum-leg{font-weight:700; letter-spacing:.02em; color:var(--accent)}
    .pill-match{display:flex; flex-direction:column; gap:6px; align-items:stretch; border:1px solid #2a3242; background:#0f1422; padding:8px 10px; border-radius:10px; font-size:.92rem; margin:6px 0}
    .pill-match .pm-title{display:flex; justify-content:center; gap:12px; align-items:center}
    .pill-match .pm-date{display:flex; justify-content:flex-end}
    .flash{box-shadow:0 0 0 3px var(--accent) inset}
    .win strong{color:var(--accent)}
    .chip{background:#202a3b; padding:.15rem .5rem; border-radius:999px; font-size:.8rem}
    .card.collapsed .bd{display:none}
    .toggler{min-width:auto} 
    .actions button,.actions select,.actions input{min-height:40px}
    button, input, select{font-size:16px}
    @media (max-width: 640px){
      .container{padding:16px}
      .card .hd{padding:10px 12px}
      .card .bd{padding:12px}
      .actions{gap:8px}
      .num{width:44px}
      .mh-title{flex-wrap:wrap; gap:8px}
      .mh-date{justify-content:stretch}
      .mh-date input{width:100%}
      .sum-grid{grid-template-columns:1fr}
      .pill-match{font-size:.95rem}
      .toggler{padding:8px 12px}
      #teamName{max-width:100%}
    }
    .mobile-tabs{display:none; gap:8px; position:sticky; top:0; z-index:5; padding:8px 0}
    .mobile-tabs button{flex:1; padding:10px 12px; border-radius:999px; border:1px solid #2a3242; background:#0f1422; color:#cfd6e6; font-weight:700}
    .mobile-tabs button.active{background:var(--accent); color:#0b0e13; border-color:transparent}
    .mobile-section{display:block}
    @media (max-width: 820px){
      .mobile-tabs{display:flex}
      .mobile-section{display:none}
      .mobile-section.active{display:block}
    }
    .sum-legend{display:flex; gap:8px; align-items:center; margin:4px 0 12px}
    .legend-dot{width:10px; height:10px; border-radius:999px; display:inline-block}
    .sum-card--ida{border-color:#2b6cb0; background:linear-gradient(180deg,#0f1a28 0%, #121a2a 100%)}
    .sum-card--vuelta{border-color:#2b7a0b; background:linear-gradient(180deg,#0f1f14 0%, #142116 100%)}
    .pill-match.pm--pending{border-left:4px solid var(--warn); background:#111824}
    .pill-match.pm--done{border-left:4px solid var(--ok); background:#0e1822}
    .pill-match:hover{box-shadow:0 0 0 2px rgba(204,255,0,.15) inset}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <header class="flex" style="justify-content:space-between; align-items:flex-start; gap:16px; margin-bottom:16px">
      <div>
        <h1>🏆 Liga Femenina – <span style="color:var(--accent)">No puedo, tengo pádel</span></h1>
        <div class="small">Parejas editables, calendario ida/vuelta, resultados por card y resumen visual. Guardado local + remoto (Supabase).</div>
      </div>
      <div class="pill">⚙️ Beta • v12 (Supabase)</div>
    </header>

    <nav class="mobile-tabs" id="mobileTabs">
      <button type="button" data-target="#sec-parejas" aria-label="Parejas">👥 Parejas</button>
      <button type="button" data-target="#sec-cuadros" aria-label="Partidos" class="active">🎾 Partidos</button>
      <button type="button" data-target="#sec-resumen" aria-label="Resumen">📋 Resumen</button>
      <button type="button" data-target="#sec-tabla" aria-label="Tabla">📊 Tabla</button>
    </nav>

    <section id="sec-parejas" class="grid mobile-section">
      <div class="card">
        <div class="hd"><strong>➕ Parejas / Jugadoras</strong><span class="small">Agrega, edita (✏️) o elimina. Meta: 7 u 8 parejas.</span></div>
        <div class="bd">
          <details id="pairsPanel">
            <summary><strong>Gestionar parejas</strong> <span id="pairsCount" class="small"></span></summary>
            <div class="actions" style="margin-top:8px">
              <input id="teamName" placeholder="Ej: Jessi/Ck" required style="max-width:260px" />
              <button id="addPair" class="primary" type="button">Agregar pareja</button>
              <button type="button" id="clearTeams" class="ghost">Vaciar</button>
            </div>
            <div id="teamList" class="compact-list" style="margin-top:8px"></div>
          </details>
        </div>
      </div>
    </section>

    <section id="sec-cuadros" class="grid mobile-section">
      <div class="card">
        <div class="hd"><strong>📆 Cuadros (Ida/Vuelta)</strong>
          <div class="actions">
            <button id="regenFixture" class="primary">Regenerar calendario</button>
            <label class="small">Vista:
              <select id="filterLeg" style="width:auto">
                <option value="ALL">Todo</option>
                <option value="ida">Ida</option>
                <option value="vuelta">Vuelta</option>
              </select>
            </label>
            <label class="small">Jornada:
              <select id="filterRound" style="width:auto"><option value="ALL">Todas</option></select>
            </label>
          </div>
        </div>
        <div class="bd">
          <div class="small" style="margin-bottom:8px">Con <strong>7</strong> parejas hay <strong>21</strong> partidos por leg. Si agregas una 8ª, serán <strong>28</strong> por leg.</div>
          <div id="fixtureInfo" class="small"></div>
          <div class="scroll" id="cards"></div>
        </div>
      </div>
    </section>

    <section id="sec-resumen" class="grid mobile-section">
      <div class="card" id="summaryCard">
        <div class="hd"><strong>📋 Resumen de Partidos (Ida/Vuelta)</strong>
          <div class="actions">
            <button id="toggleSummary" class="ghost toggler" type="button">Colapsar</button>
            <label class="small">Vista:
              <select id="sumLeg" style="width:auto">
                <option value="ALL">Todo</option>
                <option value="ida">Ida</option>
                <option value="vuelta">Vuelta</option>
              </select>
            </label>
            <label class="small">Jornada:
              <select id="sumRound" style="width:auto"><option value="ALL">Todas</option></select>
            </label>
            <label class="small"><input type="checkbox" id="sumShow"> Mostrar resultados</label>
          </div>
        </div>
        <div class="bd" id="summary"></div>
      </div>
    </section>

    <section id="sec-tabla" class="grid mobile-section">
      <div class="card">
        <div class="hd"><strong>📊 Tabla de posiciones</strong>
          <div class="actions">
            <button id="resetAll" class="danger">Reiniciar todo</button>
          </div>
        </div>
        <div class="bd">
          <div style="overflow:auto">
            <table id="standings">
              <thead>
                <tr>
                  <th>#</th><th>Pareja</th><th>PJ</th><th>PG</th><th>PP</th><th>Games +</th><th>Games −</th><th>Dif</th><th>Puntos</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><strong>🗓️ Partidos guardados</strong><span class="small">Puedes eliminar alguno si fue cargado por error</span></div>
        <div class="bd" id="matches"></div>
      </div>
    </section>

    <footer class="foot" style="margin-top:8px">
      <div class="small">Reglas: Victoria = <strong>3 pts</strong> • Derrota en 3 sets = <strong>0.5 pt</strong> • WO = 6–0 / 6–0.</div>
      <div class="pill">💾 Local + ☁️ Remoto (si configuras Supabase)</div>
    </footer>
  </div>

  <script>
  const SUPABASE_URL = 'https://TU-PROYECTO.supabase.co';
  const SUPABASE_ANON = 'TU-KEY-ANON';
  const sb = (window.supabase && SUPABASE_URL.startsWith('http')) ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON) : null;

  const LS_KEY = 'liga-padel-v12';
  const state = load() || { teams: [], matches: [], fixtures: { ida: [], vuelta: [] }, editing: {}, dates: {}, showSummaryResults: false };
  if(state.showSummaryResults===undefined) state.showSummaryResults = false;

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  function save(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){} }
  function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)); }catch(e){ return null } }
  function uid(){ return Math.random().toString(36).slice(2,9); }
  function n(v){ const x = Number(v); return Number.isFinite(x)? x : 0; }
  function formatPts(x){ return (Math.round(x*10)/10).toFixed(1).replace('.0',''); }
  function teamName(id){ const t = state.teams.find(t=>t.id===id); return t? t.name : '¿?'; }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch])); }
  function indexOfTeam(id){ return state.teams.findIndex(t=>t.id===id); }
  function orderPair(a,b){ const ia=indexOfTeam(a), ib=indexOfTeam(b); return (ia<=ib)? [a,b] : [b,a]; }
  function pairRank(a,b){ const [x,y]=orderPair(a,b); return [indexOfTeam(x), indexOfTeam(y)]; }
  function comparePairs(p1a,p1b,p2a,p2b){ const r1=pairRank(p1a,p1b), r2=pairRank(p2a,p2b); if(r1[0]!==r2[0]) return r1[0]-r2[0]; return r1[1]-r2[1]; }
  function toDateInputValue(v){ if(!v) return ''; const d=new Date(v); if(!isNaN(d)) return d.toISOString().slice(0,10); if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v; return ''; }

  const DEFAULT_TEAMS = ['Jessi/Ck','Vanessa/Auri','Patty/Vero','Valen/Sele','Enyor/Stef','Nathaly/Cristina','Nativid/Olga'];
  if(state.teams.length === 0){ state.teams = DEFAULT_TEAMS.map(name=>({ id: uid(), name })); save(); }

  const legSel = document.getElementById('filterLeg');
  const roundSel = document.getElementById('filterRound');
  const sumLegSel = document.getElementById('sumLeg');
  const sumRoundSel = document.getElementById('sumRound');
  const sumShowChk = document.getElementById('sumShow');

  function remoteReady(){ return !!sb; }
  async function loadRemote(){
    if(!remoteReady()) return false;
    try{
      const { data: teams, error: e1 } = await sb.from('teams').select('*').order('sort',{ascending:true});
      const { data: matches, error: e2 } = await sb.from('matches').select('*');
      if(e1||e2) throw e1||e2;
      if(Array.isArray(teams)) state.teams = teams.map(t=>({ id: t.id, name: t.name }));
      if(Array.isArray(matches)) state.matches = matches.map(m=>({ id:m.id, uniq:m.uniq, A:m.A, B:m.B, leg:m.leg, round:m.round, sets:m.sets||[], wo:!!m.wo, ptsA:m.ptsA||0, ptsB:m.ptsB||0, date:m.date||'' }));
      autoGenerateFixtures(); save();
      return true;
    }catch(err){ console.warn('loadRemote()', err); return false; }
  }
  async function upsertTeamList(){ if(!remoteReady()) return; try{ const rows = state.teams.map((t,idx)=>({ id:t.id, name:t.name, sort:idx })); await sb.from('teams').upsert(rows); }catch(e){ console.warn('upsertTeamList',e); } }
  async function upsertMatch(rec){ if(!remoteReady()) return; try{ await sb.from('matches').upsert({ id:rec.id, uniq:rec.uniq, A:rec.A, B:rec.B, leg:rec.leg, round:rec.round, sets:rec.sets, wo:rec.wo, ptsA:rec.ptsA, ptsB:rec.ptsB, date:rec.date||'' }); }catch(e){ console.warn('upsertMatch',e); } }
  async function deleteMatchRemote(id){ if(!remoteReady()) return; try{ await sb.from('matches').delete().eq('id', id); }catch(e){ console.warn('deleteMatch',e); } }
  async function clearAllMatchesRemote(){ if(!remoteReady()) return; try{ await sb.from('matches').delete().neq('id',''); }catch(e){ console.warn('clearAll',e); } }

  (async function boot(){
    await loadRemote();
    renderTeams();
    autoGenerateFixtures();
    populateFilterRounds();
    renderCards();
    populateSummaryRounds();
    renderSummary();
    renderMatches();
    renderStandings();
  })();

  (function(){ const btn = document.getElementById('toggleSummary'); const card = document.getElementById('summaryCard'); const KEY = 'summaryCollapsed';
    if(btn && card){ const initCollapsed = localStorage.getItem(KEY) === 'true'; if(initCollapsed){ card.classList.add('collapsed'); btn.textContent = 'Expandir'; }
      btn.addEventListener('click', ()=>{ const isCollapsed = card.classList.toggle('collapsed'); btn.textContent = isCollapsed ? 'Expandir' : 'Colapsar'; try{ localStorage.setItem(KEY, String(isCollapsed)); }catch(e){} });
    }})();
  (function(){ const det = document.getElementById('pairsPanel'); const KEY = 'pairsOpen'; if(!det) return; const saved = localStorage.getItem(KEY); if(saved!==null) det.open = (saved==='true'); det.addEventListener('toggle', ()=>{ try{ localStorage.setItem(KEY, String(det.open)); }catch(e){} }); })();

  document.getElementById('addPair').addEventListener('click', function(){
    const name = document.getElementById('teamName').value.trim();
    if(!name){ alert('Ingresa un nombre'); return; }
    if(state.teams.some(t=>t.name.toLowerCase()===name.toLowerCase())){ alert('Ese nombre ya existe'); return; }
    state.teams.push({ id: uid(), name });
    document.getElementById('teamName').value=''; save(); upsertTeamList();
    autoGenerateFixtures(); populateFilterRounds(); populateSummaryRounds(); renderTeams(); renderCards(); renderSummary();
  });
  document.getElementById('clearTeams').addEventListener('click', function(){
    if(!confirm('¿Vaciar parejas? Esto limpiará calendario y partidos.')) return;
    hardReset();
  });

  function renderTeams(){
    const cnt = state.teams.length;
    const cntEl = document.getElementById('pairsCount'); if(cntEl){ cntEl.textContent = `(${cnt} parejas)`; }
    if(cnt===0){ document.getElementById('teamList').innerHTML = '<span class="small">Aún no hay parejas</span>'; return; }
    const rows = state.teams.map(function(t,i){
      const editing = !!state.editing[t.id];
      const nameView = '<span>'+escapeHtml(t.name)+'</span>';
      const nameEdit = '<input type="text" value="'+escapeHtml(t.name)+'" id="edit_'+t.id+'" class="edit-input" placeholder="Editar nombre de pareja" />';
      const btns = editing
        ? '<button class="ok icon-btn" onclick="saveTeam(''+t.id+'')">💾<\/button>'+ '<button class="ghost icon-btn" onclick="cancelEdit(''+t.id+'')">✖<\/button>'
        : '<button class="ghost icon-btn" onclick="editTeam(''+t.id+'')">✏️<\/button>';
      return (
        '<div class="row" style="align-items:center">'+
          '<div class="col-10 flex" style="gap:8px">'+(editing? nameEdit : nameView)+btns+'<\/div>'+
          '<div class="col-2 actions">'+
            '<button class="ghost" onclick="moveTeam('+i+',-1)">↑<\/button>'+
            '<button class="ghost" onclick="moveTeam('+i+',1)">↓<\/button>'+
            '<button class="danger" onclick="removeTeam(''+t.id+'')">Eliminar<\/button>'+
          '<\/div>'+
        '<\/div>'
      );
    }).join('');
    document.getElementById('teamList').innerHTML = rows;
  }
  window.editTeam = function(id){ state.editing[id]=true; const p=document.getElementById('pairsPanel'); if(p && !p.open) p.open=true; renderTeams(); setTimeout(function(){ const inp=document.getElementById('edit_'+id); if(inp){ inp.focus(); inp.select(); } },0); };
  window.saveTeam = function(id){ const inp=document.getElementById('edit_'+id); if(!inp) return; const val=inp.value.trim(); if(!val){ alert('Nombre vacío'); return; } const t=state.teams.find(x=>x.id===id); if(t){ t.name=val; } delete state.editing[id]; save(); upsertTeamList(); renderTeams(); renderStandings(); renderCards(); renderMatches(); renderSummary(); };
  window.cancelEdit = function(id){ delete state.editing[id]; renderTeams(); };
  window.removeTeam = function(id){ if(!confirm('¿Eliminar pareja y sus partidos?')) return; state.teams = state.teams.filter(t=>t.id!==id); state.matches = state.matches.filter(m=>m.A!==id && m.B!==id); Object.keys(state.dates).forEach(k=>{ if(k.includes(id)) delete state.dates[k]; }); save(); upsertTeamList(); autoGenerateFixtures(); populateFilterRounds(); populateSummaryRounds(); renderTeams(); renderCards(); renderMatches(); renderStandings(); renderSummary(); };
  window.moveTeam = function(i, dir){ const j=i+dir; if(j<0||j>=state.teams.length) return; const x=state.teams.splice(i,1)[0]; state.teams.splice(j,0,x); save(); upsertTeamList(); renderTeams(); renderCards(); renderSummary(); };

  document.getElementById('regenFixture').addEventListener('click', function(){ autoGenerateFixtures(); populateFilterRounds(); populateSummaryRounds(); renderCards(); renderSummary(); });
  if(legSel) legSel.addEventListener('change', function(){ renderCards(); });
  if(roundSel) roundSel.addEventListener('change', function(){ renderCards(); });

  function populateFilterRounds(){
    const rounds = (state.fixtures && state.fixtures.ida && state.fixtures.ida.length) || 0;
    const sel = document.getElementById('filterRound'); if(!sel) return;
    const cur = sel.value;
    sel.innerHTML = '<option value="ALL">Todas</option>' + Array.from({length: rounds}, (_,i)=>'<option value="'+(i+1)+'">'+(i+1)+'</option>').join('');
    if([].slice.call(sel.options).some(o=>o.value===cur)) sel.value = cur;
  }

  function autoGenerateFixtures(){
    const nTeams = Math.min(Math.max(state.teams.length, 2), 8);
    if(nTeams<2){ state.fixtures={ida:[],vuelta:[]}; save(); return; }
    const ids = state.teams.slice(0,nTeams).map(t=>t.id);
    const ida = buildRoundRobin(ids);
    const vuelta = ida.map(r=> r.map(pair=>[pair[1], pair[0]]));
    state.fixtures = { ida, vuelta }; save();
  }

  function buildRoundRobin(ids){
    const arr = ids.slice();
    if(arr.length%2===1) arr.push('BYE');
    const n = arr.length; const rounds=[];
    for(let r=0; r<n-1; r++){
      const round=[];
      for(let i=0;i<n/2;i++){
        const a=arr[i], b=arr[n-1-i];
        if(a!=='BYE' && b!=='BYE') round.push([a,b]);
      }
      rounds.push(round);
      arr.splice(1,0,arr.pop());
    }
    return rounds;
  }

  function renderCards(){
    const root = document.getElementById('cards'); const info = document.getElementById('fixtureInfo');
    const ida = (state.fixtures && state.fixtures.ida) || []; const vuelta = (state.fixtures && state.fixtures.vuelta) || [];
    if(!ida.length && !vuelta.length){ root.innerHTML = '<div class="small">Genera el calendario para ver los cuadros de partidos.</div>'; if(info) info.textContent=''; return; }
    const nTeams = Math.min(Math.max(state.teams.length,2),8);
    const perLeg = nTeams*(nTeams-1)/2;
    if(info) info.textContent = 'Ida: '+ida.reduce((a,r)=>a+r.length,0)+' / '+perLeg+' · Vuelta: '+vuelta.reduce((a,r)=>a+r.length,0)+' / '+perLeg;

    const legFilter = (legSel||{}).value || 'ALL';
    const roundFilter = (roundSel||{}).value || 'ALL';

    function makeSetGroup(uniq, i, sets){
      const vA = (sets[i] && sets[i][0]) || ''; const vB = (sets[i] && sets[i][1]) || '';
      return '<div class="flex" style="gap:6px; align-items:center"><span class="badge">S'+(i+1)+'</span>'+
        '<input class="num" id="'+uniq+'_s'+(i+1)+'a" type="number" min="0" placeholder="A" value="'+vA+'">'+
        '<input class="num" id="'+uniq+'_s'+(i+1)+'b" type="number" min="0" placeholder="B" value="'+vB+'"></div>';
    }

    function makeCard(a,b,leg,ri,idx){
      const pairOrdered = orderPair(a,b); const aId=pairOrdered[0], bId=pairOrdered[1];
      const A = escapeHtml(teamName(aId)); const B = escapeHtml(teamName(bId));
      const pair = [aId,bId].slice().sort().join('__');
      const uniq = pair+'_'+leg+'_'+ri+'_'+idx;
      const existing = state.matches.find(m=>m.uniq===uniq);
      const sets = (existing && existing.sets) || [];
      const wo = (existing && existing.wo) ? 'checked' : '';
      const dateVal = toDateInputValue((existing && existing.date) || state.dates[uniq]);
      const dateHtml = '<div class="mh-date small">📅 <input id="'+uniq+'_date" type="date" value="'+dateVal+'"></div>';
      return '<div class="card" style="margin-bottom:10px;">        <div class="bd">          <div class="match-head">            '+dateHtml+'            <div class="mh-title"><span class="lab">A:<\/span> <strong>'+A+'<\/strong> <span class="mh-sep">|<\/span> <span class="lab">B:<\/span> <strong>'+B+'<\/strong><\/div>          <\/div>          <div class="row" style="margin-top:10px; align-items:center">            <div class="col-12 flex" style="gap:14px; flex-wrap:wrap">              '+makeSetGroup(uniq,0,sets)+'              '+makeSetGroup(uniq,1,sets)+'              '+makeSetGroup(uniq,2,sets)+'              <label class="small"><input class="chk" id="'+uniq+'_wo" type="checkbox" '+wo+'> WO<\/label>              <button class="ok" onclick="saveCard(''+aId+'',''+bId+'',''+leg+'','+ri+','+idx+')">'+(existing? 'Actualizar':'Guardar')+'<\/button>            <\/div>          <\/div>        <\/div>      <\/div>';
    }

    function jornadaBlock(title, games, leg, ri){
      const gamesSorted = games.slice().sort((g1,g2)=> comparePairs(g1[0],g1[1],g2[0],g2[1]));
      const inner = gamesSorted.map((g,idx)=> makeCard(g[0],g[1],leg,ri,idx)).join('');
      return '<details class="round" '+(ri===0?'open':'')+'><summary><h3 class="small" style="display:inline">'+title+'</h3></summary>'+ (inner || '<div class="small">Sin partidos</div>') + '</details>';
    }

    function col(title, rounds, leg){
      let mapped = rounds.map((games,ri)=>({ri,games}));
      if(roundFilter!=='ALL'){ const rIndex = Number(roundFilter)-1; mapped = mapped.filter(x=>x.ri===rIndex); }
      const blocks = mapped.map(x=> jornadaBlock('Jornada '+(x.ri+1), x.games, leg, x.ri)).join('');
      return '<div style="min-width:380px; max-width:100%; padding-right:10px">        <h2 style="margin:6px 0 10px">'+title+'<\/h2>        '+(blocks || '<div class="small">Sin partidos</div>')+'      <\/div>';
    }

    const showIda = (legFilter==='ALL' || legFilter==='ida');
    const showVuelta = (legFilter==='ALL' || legFilter==='vuelta');
    const html = '<div style="display:flex; gap:18px; align-items:flex-start">' + (showIda? col('IDA', ida, 'ida') : '') + (showVuelta? col('VUELTA', vuelta, 'vuelta') : '') + '</div>';
    root.innerHTML = html;

    $$('#cards input[type="date"]').forEach(inp=>{
      inp.addEventListener('change', function(){
        const uniq = this.id.replace('_date','');
        state.dates[uniq] = this.value || '';
        const m = state.matches.find(x=>x.uniq===uniq); if(m){ m.date = state.dates[uniq]; }
        save(); renderSummary(); renderMatches();
      });
    });
  }

  window.saveCard = function(a,b,leg,ri,idx){
    const pair = [a,b].slice().sort().join('__');
    const uniq = pair+'_'+leg+'_'+ri+'_'+idx;
    const get = id => document.getElementById(id);
    const wo = get(uniq+'_wo').checked;
    const dateInput = (get(uniq+'_date') && get(uniq+'_date').value) || state.dates[uniq] || '';
    if(dateInput) state.dates[uniq] = dateInput;
    let sets=[];
    if(wo){ sets=[[6,0],[6,0]]; }
    else{
      const ids=[[uniq+'_s1a',uniq+'_s1b'],[uniq+'_s2a',uniq+'_s2b'],[uniq+'_s3a',uniq+'_s3b']];
      const vals = ids.map(p=>[n(get(p[0]).value), n(get(p[1]).value)]).filter(ab=>ab[0]>0 || ab[1]>0);
      if(vals.length<2){ alert('Carga al menos dos sets o marca WO'); return; }
      sets = vals;
    }
    const sw = sets.reduce((acc,ab)=>{ if(ab[0]>ab[1]) acc.a++; else if(ab[1]>ab[0]) acc.b++; return acc; }, {a:0,b:0});
    if(sw.a===sw.b && sets.length<3){ alert('Empate a sets, falta el 3er set'); return; }
    const winner = sw.a>sw.b? 'A':'B';
    let ptsA=0, ptsB=0; if(winner==='A'){ ptsA+=3; if(sets.length===3) ptsB+=0.5; } else { ptsB+=3; if(sets.length===3) ptsA+=0.5; }

    const existing = state.matches.find(m=> m.uniq===uniq );
    const rec = { id: (existing && existing.id) || uid(), uniq, A:a, B:b, leg, round:ri+1, sets, wo, ptsA, ptsB, date: dateInput };
    if(existing){ Object.assign(existing, rec); } else { state.matches.push(rec); }
    save(); upsertMatch(rec);
    renderMatches(); renderStandings(); renderSummary();
    try{
      const details = get(uniq+'_date').closest('details.round');
      if(details) details.open = false;
      const sum = document.getElementById('summary');
      if(sum){ sum.scrollIntoView({behavior:'smooth', block:'start'}); sum.classList.add('flash'); setTimeout(()=> sum.classList.remove('flash'), 900); }
    }catch(e){}
  };

  function hardReset(){
    state.teams=[]; state.matches=[]; state.fixtures={ida:[], vuelta:[]}; state.dates={}; state.editing={}; state.showSummaryResults=false; save();
    renderTeams(); renderCards(); renderSummary(); renderMatches(); renderStandings(); populateFilterRounds(); populateSummaryRounds();
  }
  function hardResetAllKeepingTeams(){
    state.matches = []; state.dates = {}; save(); clearAllMatchesRemote();
    autoGenerateFixtures();
    renderCards(); renderSummary(); renderMatches(); renderStandings(); populateFilterRounds(); populateSummaryRounds();
  }

  window.deleteMatch = function(id){
    const i = state.matches.findIndex(m=>m.id===id);
    if(i<0) return;
    const rec = state.matches[i];
    if(!confirm(`¿Eliminar el partido R${rec.round || '?'} ${teamName(rec.A)} vs ${teamName(rec.B)}?`)) return;
    state.matches.splice(i,1);
    save(); deleteMatchRemote(id);
    renderMatches(); renderStandings(); renderCards(); renderSummary();
  };

  function renderMatches(){
    const root = document.getElementById('matches');
    if(state.matches.length===0){ root.innerHTML = '<div class="small">Sin partidos</div>'; return }
    const fmtDate = d=>{ if(!d) return ''; const dt=new Date(d); return isNaN(dt)? d : dt.toLocaleDateString(); };
    root.innerHTML = state.matches
      .slice().sort((a,b)=> (a.round||0)-(b.round||0) || (a.leg||'ida').localeCompare(b.leg||'ida'))
      .map(m=>{
        const aN=escapeHtml(teamName(m.A)), bN=escapeHtml(teamName(m.B));
        const winA = m.ptsA>m.ptsB, winB = m.ptsB>m.ptsA;
        const aLabel = winA? '🏅 '+aN : aN;
        const bLabel = winB? '🏅 '+bN : bN;
        const setsTxt = (m.sets||[]).map(ab=> n(ab[0])+'-'+n(ab[1]) ).join(', ');
        const tag = m.wo? '<span class="tag">WO</span>' : '';
        const dateSrc = m.date || state.dates[m.uniq] || '';
        const when = dateSrc? ' • <span class="small">'+fmtDate(dateSrc)+'</span>' : '';
        return '<div class="flex" style="justify-content:space-between; padding:8px 0; border-bottom:1px dashed #263044">          <div>            <div><span class="tag">R'+(m.round||'?')+' </span> <strong>'+aLabel+'</strong> vs <strong>'+bLabel+'</strong>'+when+'</div>            <div class="small">Sets: '+setsTxt+' '+tag+'</div>          </div>          <div class="actions">            <button class="danger" onclick="deleteMatch(''+m.id+'')">Eliminar</button>          </div>        </div>';
      }).join('');
  };

  function renderStandings(){
    const stats = {};
    state.teams.forEach(t=>{ stats[t.id]={ id:t.id, name:t.name, PJ:0, PG:0, PP:0, GW:0, GL:0, PTS:0 }; });
    state.matches.forEach(m=>{
      const {A,B,sets,ptsA,ptsB} = m; if(!stats[A]||!stats[B]) return;
      stats[A].PJ++; stats[B].PJ++;
      let sA=0,sB=0, gA=0,gB=0;
      sets.forEach(ab=>{ const a=n(ab && ab[0]); const b=n(ab && ab[1]); if(a>b) sA++; else if(b>a) sB++; gA+=a; gB+=b; });
      stats[A].GW+=gA; stats[A].GL+=gB; stats[B].GW+=gB; stats[B].GL+=gA;
      if(sA>sB){ stats[A].PG++; stats[B].PP++; } else { stats[B].PG++; stats[A].PP++; }
      stats[A].PTS+=ptsA; stats[B].PTS+=ptsB;
    });
    const arr = state.teams.map(t=>stats[t.id]).filter(Boolean);
    const tbody=document.querySelector('#standings tbody');
    tbody.innerHTML = arr.map((r,i)=>`<tr><td>${i+1}</td><td>${escapeHtml(r.name)}</td><td>${r.PJ}</td><td>${r.PG}</td><td>${r.PP}</td><td>${r.GW}</td><td>${r.GL}</td><td>${r.GW-r.GL}</td><td><strong>${formatPts(r.PTS)}</strong></td></tr>`).join('')
      || `<tr><td colspan="9" class="small">Agrega resultados para ver la tabla</td></tr>`;
  }

  if(sumLegSel) sumLegSel.addEventListener('change', renderSummary);
  if(sumRoundSel) sumRoundSel.addEventListener('change', renderSummary);
  if(sumShowChk){ sumShowChk.checked = !!state.showSummaryResults; sumShowChk.addEventListener('change', function(){ state.showSummaryResults = this.checked; save(); renderSummary(); }); }

  function populateSummaryRounds(){
    const rounds = (state.fixtures && state.fixtures.ida && state.fixtures.ida.length) || 0;
    const sel = document.getElementById('sumRound'); if(!sel) return;
    const cur = sel.value;
    sel.innerHTML = '<option value="ALL">Todas</option>' + Array.from({length: rounds}, (_,i)=>'<option value="'+(i+1)+'">'+(i+1)+'</option>').join('');
    if([].slice.call(sel.options).some(o=>o.value===cur)) sel.value = cur;
  }

  function renderSummary(){
    const box = document.getElementById('summary'); if(!box) return;
    const legFilter = (document.getElementById('sumLeg')||{}).value || 'ALL';
    const roundFilter = (document.getElementById('sumRound')||{}).value || 'ALL';
    const showResults = (document.getElementById('sumShow')||{}).checked || false;
    const legs=[];
    if(legFilter==='ALL' || legFilter==='ida') legs.push(['IDA', state.fixtures.ida, 'ida']);
    if(legFilter==='ALL' || legFilter==='vuelta') legs.push(['VUELTA', state.fixtures.vuelta, 'vuelta']);
    const makeBlock = (title, rounds, leg)=>{
      if(!rounds || !rounds.length) return '';
      const cards = rounds.map((games,i)=>{
        if(roundFilter!=='ALL' && i!==Number(roundFilter)-1) return '';
        const gamesSorted = games.slice().sort((g1,g2)=> comparePairs(g1[0],g1[1],g2[0],g2[1]));
        const items = gamesSorted.map((pair,idx)=>{
          const [a,b] = orderPair(pair[0], pair[1]);
          const pairKey = [a,b].slice().sort().join('__');
          const uniq = pairKey+'_'+leg+'_'+i+'_'+idx;
          const rec = state.matches.find(m=>m.uniq===uniq);
          const aN = escapeHtml(teamName(a)); const bN = escapeHtml(teamName(b));
          let labA = aN, labB = bN, chip='';
          if(rec && showResults){
            const winA = rec.ptsA>rec.ptsB, winB = rec.ptsB>rec.ptsA;
            if(winA) labA = '<span class="win">🏅 <strong>'+labA+'</strong></span>';
            if(winB) labB = '<span class="win">🏅 <strong>'+labB+'</strong></span>';
            const setsTxt = (rec.sets||[]).map(ab=> n(ab[0])+'-'+n(ab[1]) ).join(', ');
            if(setsTxt) chip = '<div class="small">🧾 <span class="chip">'+setsTxt+'</span></div>';
          }
          const dateVal = toDateInputValue((rec||{}).date || state.dates[uniq]);
          return `
            <div class="pill-match ${rec ? 'pm--done' : 'pm--pending'}" id="pill_${uniq}">
              <div class="pm-date small">📅 <input type="date" id="sum_${uniq}" value="${dateVal}" style="width:auto"></div>
              <div class="pm-title">🎾 <span class="lab">A:</span> <strong>${labA}</strong> <span class="mh-sep">|</span> <span class="lab">B:</span> <strong>${labB}</strong></div>
              ${chip}
              <div class="actions" style="justify-content:center; margin-top:6px">
                <button class="ghost" onclick="openMatch('${uniq}')">Ir al partido</button>
              </div>
            </div>`;
        }).join('');
        return `<div class="sum-card sum-card--${leg}"><h4><span class="sum-leg">${title}</span> · Jornada ${i+1}</h4>${items || '<span class="small">(sin partidos)</span>'}</div>`;
      }).join('');
      return cards;
    };
    box.innerHTML = `<div class="sum-legend small">
  <span class="legend-dot" style="background:#2b6cb0"></span> Ida
  <span class="legend-dot" style="background:#2b7a0b; margin-left:10px"></span> Vuelta
  <span class="legend-dot" style="background:#ffc107; margin-left:10px"></span> Pendiente
  <span class="legend-dot" style="background:#32d296; margin-left:10px"></span> Cargado
</div><div class="sum-grid">${legs.map(([t,r,k])=>makeBlock(t,r,k)).join('')}</div>`;

    $$('#summary input[type="date"]').forEach(inp=>{
      inp.addEventListener('change', function(){
        const uniq = this.id.replace('sum_','');
        state.dates[uniq] = this.value || '';
        const m = state.matches.find(x=>x.uniq===uniq); if(m){ m.date = state.dates[uniq]; }
        save(); renderCards(); renderMatches();
      });
    });
  }

  window.openMatch = function(uniq){
    try{
      const el = document.getElementById(uniq+'_date');
      if(!el){ alert('No encontré la card del partido en Cuadros.'); return; }
      const det = el.closest('details.round');
      if(det) det.open = true;
      el.scrollIntoView({behavior:'smooth', block:'center'});
      el.classList.add('flash'); setTimeout(()=> el.classList.remove('flash'), 1200);
    }catch(e){ console.error(e); }
  };

  document.getElementById('resetAll').addEventListener('click', function(){
    if(!confirm('¿Reiniciar la tabla y los resultados? (Se conservan las parejas)')) return;
    try{ localStorage.removeItem(LS_KEY); }catch(e){}
    hardResetAllKeepingTeams();
  });

  (function(){
    const tabs = document.querySelectorAll('#mobileTabs button');
    const sections = ['#sec-parejas','#sec-cuadros','#sec-resumen','#sec-tabla'].map(s=>document.querySelector(s));
    function isMobile(){ return window.matchMedia('(max-width: 820px)').matches; }
    function activate(targetSel){
      tabs.forEach(btn=>btn.classList.toggle('active', btn.getAttribute('data-target')===targetSel));
      sections.forEach(sec=>{ if(!sec) return; sec.classList.toggle('active', '#'+sec.id===targetSel); sec.classList.toggle('mobile-section', true); });
    }
    function init(){ if(isMobile()){ activate('#sec-cuadros'); } else { sections.forEach(sec=>sec && (sec.classList.add('mobile-section'), sec.classList.add('active'))); } }
    init();
    tabs.forEach(btn=> btn.addEventListener('click', ()=> activate(btn.getAttribute('data-target'))));
    window.addEventListener('resize', ()=>{
      if(isMobile()){
        const current = document.querySelector('#mobileTabs button.active');
        const sel = current ? current.getAttribute('data-target') : '#sec-cuadros';
        activate(sel);
      } else {
        sections.forEach(sec=>sec && (sec.classList.add('active')));
      }
    });
  })();
  </script>
</body>
</html>
